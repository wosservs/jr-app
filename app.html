<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Roman√©io ‚Ä¢ Painel</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1420;--panel:#121b28;--muted:#0f1722;--card:#0e1825;
    --text:#e6edf3;--sub:#9fb0c3;--pri:#3b82f6;--ok:#10b981;--err:#ef4444;--warn:#f59e0b;
    --line:#1f2a3a;
    --radius:14px;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit} button{cursor:pointer}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--line);border-radius:999px;padding:8px 12px;color:var(--sub);font-weight:600}
  .btn{background:var(--pri);border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:700}
  .btn.muted{background:var(--muted);color:var(--sub)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
  .btn.warn{background:var(--warn)}
  .btn.ok{background:var(--ok)}
  .btn.err{background:var(--err)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
  h1{font-size:20px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 10px;color:#cde}
  label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
  input,select,textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:#3b82f6}
  .grid3{display:grid;grid-template-columns:1.5fr 1fr 100px;gap:10px}
  .itemsWrap{display:flex;flex-direction:column;gap:10px}
  .itemLine{display:grid;grid-template-columns:1.2fr 1fr 100px 40px;gap:10px}
  .pill{background:#0c2239;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:#b6c9dd;font-size:12px}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .thumbs img{height:80px;width:auto;border-radius:8px;border:1px solid var(--line)}
  .tabs{display:flex;gap:10px;align-items:center;margin:6px 0 14px}
  .tab{background:var(--muted);border:1px solid var(--line);color:var(--sub);padding:8px 10px;border-radius:999px}
  .tab.active{background:var(--pri);color:white}
  .hidden{display:none}
  .bar{position:fixed;left:0;top:0;height:3px;background:var(--pri);width:0%;transition:width .2s ease;z-index:9999}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
  .hint{color:var(--sub);font-size:12px}
</style>
</head>
<body>
<div class="bar" id="bar"></div>

<div class="container">

  <div class="topbar">
    <div class="chip">üöö Roman√©io</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="btnRefresh">‚ü≥ Atualizar</button>
      <button class="btn err" id="btnLogout">Sair</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabNew">Novo</button>
    <button class="tab" id="tabList">Roman√©ios</button>
    <span class="pill" id="who"></span>
  </div>

  <!-- NOVO ROMANEIO -->
  <section id="pageNew">
    <div class="panel">
      <h1>Cliente & Fornecedor</h1>
      <div class="row">
        <div>
          <label>ROM</label>
          <input id="rom" placeholder="Ex.: 21">
        </div>
        <div>
          <label>Data</label>
          <input id="data" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cliente ‚Ä¢ Telefone</label>
          <input id="cli_tel" placeholder="(85) 9 9999-9999">
        </div>
        <div>
          <label>Cliente ‚Ä¢ Nome</label>
          <input id="cli_nome" placeholder="Nome do cliente">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cliente ‚Ä¢ Cidade/UF</label>
          <input id="cli_local" placeholder="Ex.: Fortaleza/CE">
        </div>
        <div>
          <label>Fornecedor ‚Ä¢ Telefone</label>
          <input id="for_tel" placeholder="(85) 3333-3333">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fornecedor ‚Ä¢ Nome</label>
          <input id="for_nome" placeholder="Nome do fornecedor">
        </div>
        <div>
          <label>Fornecedor ‚Ä¢ Cidade/UF</label>
          <input id="for_local" placeholder="Ex.: Maracana√∫/CE">
        </div>
      </div>
    </div>

    <div class="panel">
      <h1>Itens</h1>
      <div class="itemsWrap" id="items"></div>
      <div style="margin-top:10px;display:flex;gap:10px">
        <button class="btn ghost" id="addItem">+ Adicionar item</button>
        <span class="pill" id="totalItens">Total: 0</span>
      </div>
    </div>

    <div class="panel">
      <h1>Fotos</h1>
      <div class="hint">Voc√™ pode selecionar v√°rias imagens. Pr√©-visualiza√ß√£o abaixo.</div>
      <input type="file" id="file" accept="image/*" multiple>
      <div class="thumbs" id="thumbs"></div>

      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn ok" id="btnEnviar">Enviar</button>
        <button class="btn muted" id="btnLimpar">Limpar</button>
      </div>
    </div>
  </section>

  <!-- LISTA / FILTROS -->
  <section id="pageList" class="hidden">
    <div class="panel">
      <h1>Roman√©ios</h1>
      <div class="row">
        <div>
          <label>ROM</label>
          <select id="fRom"></select>
        </div>
        <div>
          <label>Cidade do Cliente</label>
          <select id="fCidade"></select>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px">
        <button class="btn" id="btnFiltrar">Filtrar</button>
        <button class="btn ghost" id="btnPdf">Exportar PDF</button>
      </div>
      <table class="table" id="tbl"></table>
    </div>
  </section>

</div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec"; // <‚Äî troque pelo seu /exec
const bar = (p)=>{ document.getElementById('bar').style.width = p+'%'; }
const token = localStorage.getItem('token')||'';
const whoEl = document.getElementById('who');

/* ====== HELPERS ====== */
const fmtPhone = (v)=>{
  v = String(v||'').replace(/\D/g,'');
  if(v.startsWith('0')) v=v.slice(1);
  if(v.length<=10){
    // fixo (8 digitos) ou celular antigo (8)
    return v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
  }else{
    // celular 9 digitos
    return v.replace(/^(\d{2})(\d{1})(\d{4})(\d{0,4}).*/, '($1) $2 $3-$4');
  }
};
const onlyDigits = s=>String(s||'').replace(/\D/g,'');

async function api(path, payload={}){
  bar(25);
  const res = await fetch(API_BASE+"?path="+encodeURIComponent(path),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...payload, token})
  });
  bar(55);
  const js = await res.json().catch(()=> ({}));
  bar(100); setTimeout(()=>bar(0),200);
  if(js.error){ throw new Error(js.error); }
  return js;
}

/* ====== LOGIN INFO ====== */
(async ()=>{
  try{
    const w = await api('/whoami');
    if(w.session){
      whoEl.textContent = `${w.session.usuario} ‚Ä¢ expira ${new Date(w.session.expira).toLocaleTimeString()}`;
    }else{
      location.href = 'index.html';
    }
  }catch(e){
    alert("Sess√£o inv√°lida. Fa√ßa login novamente.");
    location.href='index.html';
  }
})();

/* ====== TABS ====== */
const pageNew = document.getElementById('pageNew');
const pageList= document.getElementById('pageList');
document.getElementById('tabNew').onclick = ()=>{
  pageNew.classList.remove('hidden');
  pageList.classList.add('hidden');
  document.getElementById('tabNew').classList.add('active');
  document.getElementById('tabList').classList.remove('active');
}
document.getElementById('tabList').onclick = ()=>{
  pageList.classList.remove('hidden');
  pageNew.classList.add('hidden');
  document.getElementById('tabList').classList.add('active');
  document.getElementById('tabNew').classList.remove('active');
  loadFilters();
  loadList();
}

/* ====== CAMPOS ====== */
const rom = document.getElementById('rom');
const data = document.getElementById('data');
const cli_tel = document.getElementById('cli_tel');
const cli_nome= document.getElementById('cli_nome');
const cli_local=document.getElementById('cli_local');
const for_tel = document.getElementById('for_tel');
const for_nome= document.getElementById('for_nome');
const for_local=document.getElementById('for_local');

data.valueAsDate = new Date();
[cli_tel,for_tel].forEach(i=>{
  i.addEventListener('input',()=> i.value = fmtPhone(i.value));
  i.addEventListener('change',()=> lookupContato(i===cli_tel?'cliente':'fornecedor'));
});

/* ====== LOOKUP CONTATO (opcional) ====== */
async function lookupContato(tipo){
  const tel = tipo==='cliente'? cli_tel.value : for_tel.value;
  const nd = onlyDigits(tel);
  if(nd.length<10) return;
  try{
    const r = await api('/contatos/lookup',{tipo, tel: nd});
    if(r && r.nome){
      if(tipo==='cliente'){ cli_nome.value=r.nome||''; cli_local.value=r.cidade_uf||''; }
      else{ for_nome.value=r.nome||''; for_local.value=r.cidade_uf||''; }
    }
  }catch(e){
    // silencioso ‚Äì se n√£o existir o endpoint, segue em frente
  }
}

/* ====== ITENS DIN√ÇMICOS ====== */
const itemsWrap = document.getElementById('items');
const totalItensEl = document.getElementById('totalItens');

function makeItem(tipo='Caixa', tam='P', qtd=1){
  const line = document.createElement('div');
  line.className='itemLine';
  line.innerHTML = `
    <select class="it_tipo">
      <option>Caixa</option><option>Saco</option><option>P√ß</option><option>Outro</option>
    </select>
    <select class="it_tam">
      <option>P</option><option>M</option><option>G</option><option>GG</option>
    </select>
    <input type="number" min="1" class="it_qtd" value="${qtd}">
    <button class="btn err it_del">√ó</button>
  `;
  line.querySelector('.it_tipo').value = tipo;
  line.querySelector('.it_tam').value = tam;
  line.querySelector('.it_del').onclick = ()=>{ line.remove(); recalc(); };
  itemsWrap.appendChild(line);
  recalc();
}
function recalc(){
  const q = [...itemsWrap.querySelectorAll('.it_qtd')].map(i=>+i.value||0)
             .reduce((a,b)=>a+b,0);
  totalItensEl.textContent = `Total: ${q}`;
}
document.getElementById('addItem').onclick = ()=> makeItem();
makeItem(); // uma linha inicial

/* ====== FOTOS (pr√©-visualiza√ß√£o) ====== */
const file = document.getElementById('file');
const thumbs = document.getElementById('thumbs');
let fotosData = [];

file.addEventListener('change', async ()=>{
  thumbs.innerHTML=''; fotosData=[];
  const files = [...file.files||[]];
  for(const f of files){
    const dataUrl = await readAsDataURL(f);
    fotosData.push({dataUrl});
    const img = document.createElement('img');
    img.src = dataUrl; thumbs.appendChild(img);
  }
});
function readAsDataURL(f){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror= rej;
    fr.readAsDataURL(f);
  });
}

/* ====== ENVIAR ====== */
document.getElementById('btnEnviar').onclick = async ()=>{
  try{
    // valida√ß√µes
    const ndCli = onlyDigits(cli_tel.value);
    const ndFor = onlyDigits(for_tel.value);
    if(!rom.value.trim())   return alert('ROM √© obrigat√≥rio');
    if(!ndCli||ndCli.length<10) return alert('Telefone do cliente inv√°lido');
    if(!cli_nome.value.trim()||!cli_local.value.trim()) return alert('Preencha nome e cidade/UF do cliente');
    if(!ndFor||ndFor.length<10) return alert('Telefone do fornecedor inv√°lido');
    if(!for_nome.value.trim()||!for_local.value.trim()) return alert('Preencha nome e cidade/UF do fornecedor');

    const itens = [...itemsWrap.querySelectorAll('.itemLine')].map(line=>{
      return {
        tipo: line.querySelector('.it_tipo').value,
        tamanho: line.querySelector('.it_tam').value,
        qtd: +line.querySelector('.it_qtd').value||0
      }
    }).filter(i=>i.qtd>0);
    if(!itens.length) return alert('Inclua pelo menos 1 item');

    const body = {
      rom: rom.value.trim(),
      data: data.value,
      cliente: { tel: ndCli, nome: cli_nome.value.trim(), local: cli_local.value.trim() },
      fornecedor: { tel: ndFor, nome: for_nome.value.trim(), local: for_local.value.trim() },
      itens,
      fotos: fotosData // array {dataUrl}
    };

    const r = await api('/rom/create', body);
    if(r.ok){
      const wa = r.whatsappUrl || '';
      const pdf = r.pdfUrl || '';
      alert('Romaneio enviado!');

      if (wa){
        const go = confirm('Abrir WhatsApp com o comprovante?');
        if(go) window.open(wa,'_blank');
      }
      if (pdf){
        const go = confirm('Abrir PDF do romaneio?');
        if(go) window.open(pdf,'_blank');
      }
      // limpa
      document.getElementById('btnLimpar').click();
    }else{
      throw new Error(r.error||'Falha desconhecida');
    }
  }catch(e){
    alert('Erro ao enviar: '+e.message);
  }
};

document.getElementById('btnLimpar').onclick = ()=>{
  [rom,cli_tel,cli_nome,cli_local,for_tel,for_nome,for_local].forEach(i=>i.value='');
  data.valueAsDate = new Date();
  itemsWrap.innerHTML=''; makeItem();
  thumbs.innerHTML=''; fotosData=[];
  file.value='';
};

/* ====== LISTA / FILTROS ====== */
const fRom = document.getElementById('fRom');
const fCidade = document.getElementById('fCidade');
const tbl = document.getElementById('tbl');

async function loadFilters(){
  try{
    const r = await api('/rom/filters',{});
    fRom.innerHTML = '<option value="">Todos</option>' + (r.roms||[]).map(n=>`<option>${n}</option>`).join('');
    fCidade.innerHTML = '<option value="">Todas</option>' + (r.cidades||[]).map(c=>`<option>${c}</option>`).join('');
  }catch(e){
    alert('Falha ao carregar filtros');
  }
}
async function loadList(){
  try{
    const r = await api('/rom/list',{ rom: fRom.value||'', cidade: fCidade.value||'' });
    const rows = r.rows||[];
    tbl.innerHTML = `<tr><th>Data</th><th>ROM</th><th>Cliente</th><th>Cidade</th><th>Fornecedor</th><th>Item</th><th>Qtd</th></tr>` +
      rows.map(x=>`<tr>
        <td>${x.data||''}</td>
        <td>${x.rom||''}</td>
        <td>${x.cli_nome||''}</td>
        <td>${x.cli_cidade_uf||''}</td>
        <td>${x.for_nome||''}</td>
        <td>${x.itens||''}</td>
        <td>${x.total_qtd||''}</td>
      </tr>`).join('');
  }catch(e){
    alert('Falha ao listar: '+e.message);
  }
}
document.getElementById('btnFiltrar').onclick = loadList;
document.getElementById('btnPdf').onclick = async ()=>{
  try{
    const r = await api('/rom/pdf',{ rom: fRom.value||'', cidade: fCidade.value||'' });
    if(r.pdfUrl) window.open(r.pdfUrl,'_blank');
  }catch(e){
    alert('Falha ao exportar PDF: '+e.message);
  }
};

/* ====== TOPO ====== */
document.getElementById('btnRefresh').onclick = ()=> location.reload();
document.getElementById('btnLogout').onclick = async ()=>{
  try{ await api('/logout',{});}catch(_){}
  localStorage.removeItem('token'); location.href='index.html';
}
</script>
</body>
</html>
