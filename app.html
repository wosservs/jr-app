<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --chip:#111827; --bar:#60a5fa;
      --line:#1f2937;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --primary:#1d4ed8; --danger:#dc2626; --ok:#16a34a; --chip:#eef2ff; --bar:#3b82f6;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 18px;z-index:10}
    nav a{color:var(--text);text-decoration:none;padding:10px 14px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .theme{background:transparent;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h2{margin:0 0 12px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    select,input[type=text],input[type=number],input[type=date],textarea{width:100%;padding:10px 12px;border:1px solid var(--line);background:transparent;border-radius:10px;color:var(--text)}
    textarea{min-height:44px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:10px;align-items:center}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn-danger{background:var(--danger);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;border:0;background:var(--danger);color:#fff;cursor:pointer}
    .msg{margin-top:10px;padding:10px;border-radius:10px}
    .ok{background:#064e3b;color:#a7f3d0}
    .err{background:#7f1d1d;color:#fecaca}
    .topbar{position:fixed;inset:0 0 auto 0;height:3px;background:transparent;z-index:20}
    .bar{height:100%;width:0;background:var(--bar);transition:width .2s linear}
    .section{margin-bottom:16px}

    /* ===== Modal de sucesso ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      width:min(560px, 92vw);
      background:var(--card); color:var(--text);
      border:1px solid var(--line); border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      padding:18px;
    }
    .modal h3{ margin:0 0 8px }
    .modal .muted{ color:var(--muted) }
    .modal .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:14px }
    .modal .btn{ cursor:pointer; border:0; border-radius:10px; padding:10px 14px; font-weight:600 }
    .modal .btn-primary{ background:var(--primary); color:#fff }
    .modal .btn-ghost{ background:transparent; color:var(--text); border:1px solid var(--line) }
    .modal .btn-ok{ background:var(--ok); color:#022c22 }
    .modal .btn-danger{ background:var(--danger); color:#fff }
  </style>
</head>
<body>
  <div class="topbar"><div id="bar" class="bar"></div></div>

  <header>
    <div class="row">
      <strong>üöö Romaneio</strong>
      <span id="who" class="muted"></span>
    </div>
    <nav class="row">
      <a href="#rom" id="mRom">Enviar Romaneio</a>
      <a href="#list">Romaneios</a>
      <a href="#clientes">Clientes</a>
      <a href="#users">Usu√°rios</a>
      <button id="btnTheme" class="theme">üåô/‚òÄÔ∏è</button>
      <a href="#" id="logout" class="btn-ghost">Sair</a>
    </nav>
  </header>

  <div class="container">
    <div class="card section" id="secRom">
      <h2>Enviar Romaneio</h2>

      <div class="row">
        <div style="flex:1">
          <label>ROM *</label>
          <input id="rom" type="number" placeholder="Ex.: 21">
        </div>
        <div style="flex:1">
          <label>Data *</label>
          <input id="data" type="date">
        </div>
      </div>

      <h3 class="muted" style="margin-top:4px">Cliente & Fornecedor</h3>
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Cliente ‚Ä¢ Telefone *</label>
          <input id="cli_tel" type="text" inputmode="numeric" placeholder="(85) 9 9999-9999">
        </div>
        <div style="flex:1;min-width:260px">
          <label>Cliente ‚Ä¢ Nome *</label>
          <input id="cli_nome" type="text" placeholder="Nome do cliente">
        </div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Cliente ‚Ä¢ Cidade/UF *</label>
          <input id="cli_local" type="text" placeholder="Fortaleza/CE" list="dl_cities" autocomplete="off">
        </div>
        <div style="flex:1;min-width:260px">
          <label>Fornecedor ‚Ä¢ Telefone *</label>
          <input id="for_tel" type="text" inputmode="numeric" placeholder="(85) 3333-3333">
        </div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>Fornecedor ‚Ä¢ Nome *</label>
          <input id="for_nome" type="text" placeholder="Nome do fornecedor">
        </div>
        <div style="flex:1;min-width:260px">
          <label>Fornecedor ‚Ä¢ Cidade/UF *</label>
          <input id="for_local" type="text" placeholder="Maracana√∫/CE" list="dl_cities" autocomplete="off">
        </div>
      </div>

      <label style="margin-top:8px">Obs.</label>
      <input id="obs" type="text" placeholder="Ex.: Doca 3, at√© 16h">

      <h3 class="muted" style="margin-top:12px">Itens</h3>
      <div id="itens"></div>
      <div class="row" style="margin-top:8px">
        <button id="addItem" class="btn-ghost">+ Adicionar item</button>
        <span class="muted">Total: <b id="totalQtd">0</b></span>
      </div>

      <h3 class="muted" style="margin-top:12px">Fotos</h3>
      <input id="fotos" type="file" accept="image/*" capture="environment" multiple>
      <div id="thumbs" class="thumbs"></div>

      <div class="row" style="margin-top:14px">
        <button id="enviar" class="btn btn-primary">Enviar</button>
        <button id="limpar" class="btn btn-ghost">Limpar</button>
      </div>

      <div id="msg" style="display:none"></div>
    </div>

    <div class="card section">
      <h2>Romaneios</h2>
      <p class="muted">Lista/relat√≥rios numa pr√≥xima etapa.</p>
    </div>
  </div>

  <!-- datalist compartilhado para cidades -->
  <datalist id="dl_cities"></datalist>

<script>
/* ======================== CONFIG & CORE ======================== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";
const bar = document.getElementById('bar');
const $id = (s)=>document.getElementById(s);
const onlyDigits = (s)=> String(s||'').replace(/\D/g,'');
function barStart(){ bar.style.width='20%'; let w=20; window._barInt=setInterval(()=>{w=Math.min(95,w+5); bar.style.width=w+'%'},200)}
function barDone(){ clearInterval(window._barInt); bar.style.width='100%'; setTimeout(()=>bar.style.width='0',300)}
function setTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t) }
(function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved){ setTheme(saved) } else { setTheme(window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark') }
})();
document.getElementById('btnTheme').onclick = ()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

const sess = (function(){ try{return JSON.parse(localStorage.getItem('session')||'{}')}catch(_){return{}} })();
if(!sess.token){ location.href='index.html'; }
document.getElementById('who').textContent = (sess.usuario||'') ? `${sess.usuario} ¬∑ ${(sess.role||'')}` : '';

function showMsg(kind, text){
  const el = $id('msg');
  el.className = 'msg '+(kind==='err'?'err':'ok');
  el.textContent = text;
  el.style.display = 'block';
}

async function post(path, body={}){
  barStart();
  try{
    const r = await fetch(API_BASE+"?path="+encodeURIComponent(path), {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({...body, token:sess.token})
    });
    barDone();
    return await r.json();
  }catch(e){ barDone(); throw e }
}

document.getElementById('logout').onclick = async (e)=>{
  e.preventDefault();
  try{ await post('/logout',{}); }catch(_){}
  localStorage.removeItem('session');
  location.href='index.html';
};

/* ======================== M√ÅSCARA TEL BR ====================== */
function formatBrPhone(raw){
  const d = onlyDigits(raw).slice(0,11);
  if(d.length<=10){
    // fixo 10 d√≠gitos: (DD) XXXX-XXXX
    const p1 = d.slice(0,2), p2=d.slice(2,6), p3=d.slice(6,10);
    return d.length>6 ? `(${p1}) ${p2}-${p3}` : d.length>2 ? `(${p1}) ${p2}` : d;
  }else{
    // celular 11 d√≠gitos: (DD) 9XXXX-XXXX
    const p1=d.slice(0,2), p2=d.slice(2,7), p3=d.slice(7,11);
    return `(${p1}) ${p2}-${p3}`;
  }
}
['cli_tel','for_tel'].forEach(id=>{
  const el = $id(id);
  el.addEventListener('input', ()=> el.value = formatBrPhone(el.value));
});

/* ======================== CIDADES (autocomplete) =============== */
const dlCities = $id('dl_cities');
let cityTimer=null;
async function fetchCitiesLike(q){
  if(!q || q.length<3) return;
  try{
    const r = await fetch(API_BASE+"?path="+encodeURIComponent('/cities')+"&q="+encodeURIComponent(q), {method:'GET'});
    if(!r.ok) return;
    const js = await r.json();
    if(Array.isArray(js.cities)){
      dlCities.innerHTML = js.cities.slice(0,100).map(c=>`<option value="${c}">`).join('');
    }
  }catch(_){}
}
function bindCitySuggest(inputId){
  const el = $id(inputId);
  el.addEventListener('input', ()=>{
    const v = el.value.trim();
    clearTimeout(cityTimer);
    cityTimer=setTimeout(()=>fetchCitiesLike(v), 250);
  });
}
bindCitySuggest('cli_local');
bindCitySuggest('for_local');

/* ======================== ITENS ================================ */
const tipos = ['Caixa','Saco','Palete','Outros'];
const tamanhos = ['P','M','G'];

const itensDiv = $id('itens');
const totalQtdEl = $id('totalQtd');
function somaTotal(){ 
  let t=0; document.querySelectorAll('.qtd').forEach(i=> t += Number(i.value||0)); 
  totalQtdEl.textContent = t; 
}
function itemRow(){
  const row = document.createElement('div');
  row.className='grid';

  const selTipo = document.createElement('select');
  tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o) });

  const selTam = document.createElement('select');
  tamanhos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTam.appendChild(o) });

  const qtd = document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='1'; qtd.className='qtd'; qtd.oninput=somaTotal;

  const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='x'; del.onclick=()=>{ row.remove(); somaTotal(); };

  row.appendChild(selTipo); row.appendChild(selTam); row.appendChild(qtd); row.appendChild(del);
  return row;
}
$id('addItem').onclick = ()=>{ itensDiv.appendChild(itemRow()); somaTotal(); };
/* cria duas linhas de exemplo */
itensDiv.appendChild(itemRow()); itensDiv.appendChild(itemRow()); somaTotal();

/* ======================== FOTOS ================================ */
const fileInput = $id('fotos');
const thumbs = $id('thumbs');
let fotosData = []; // dataURL

fileInput.onchange = async (ev)=>{
  const files = Array.from(ev.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const dataUrl = await fileToDataURL(f);
    fotosData.push(dataUrl);
  }
  renderThumbs();
};
function renderThumbs(){
  thumbs.innerHTML='';
  fotosData.forEach((d,i)=>{
    const box=document.createElement('div'); box.className='thumb';
    const img=new Image(); img.src=d; box.appendChild(img);
    const x=document.createElement('button'); x.textContent='√ó'; x.onclick=()=>{ fotosData.splice(i,1); renderThumbs(); };
    box.appendChild(x);
    thumbs.appendChild(box);
  });
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}

/* ======================== DATAS & LIMPAR ======================= */
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10) }
$id('data').value = todayISO();

$id('limpar').onclick = ()=>{
  $id('rom').value='';
  $id('cli_tel').value=''; $id('cli_nome').value=''; $id('cli_local').value='';
  $id('for_tel').value=''; $id('for_nome').value=''; $id('for_local').value='';
  $id('obs').value='';
  itensDiv.innerHTML=''; itensDiv.appendChild(itemRow()); somaTotal();
  fileInput.value=''; fotosData=[]; renderThumbs();
  $id('msg').style.display='none';
};

/* ======================== MODAL DE SUCESSO ===================== */
function buildWaLink(tel, cod, receiptUrl){
  const phone = onlyDigits(tel);
  if(!phone) return null;
  const msg = `Romaneio ${cod} enviado.%0AComprovante:%0A${receiptUrl}`;
  return `https://wa.me/55${phone}?text=${msg}`;
}
function openSuccessModal({ cod, receiptUrl, pdfUrl, telCliente, telFornecedor }){
  const old = document.querySelector('.modal-backdrop'); if(old) old.remove();

  const waCli = buildWaLink(telCliente, cod, receiptUrl);
  const waFor = buildWaLink(telFornecedor, cod, receiptUrl);

  const wrap = document.createElement('div');
  wrap.className = 'modal-backdrop';
  wrap.innerHTML = `
    <div class="modal">
      <h3>Romaneio enviado com sucesso <span class="muted">‚Ä¢ c√≥d ${cod}</span></h3>
      <p class="muted">Voc√™ pode abrir o comprovante (HTML p√∫blico), abrir o PDF ou enviar pelo WhatsApp.</p>

      <div class="row">
        <button class="btn btn-primary" id="btnOpenReceipt">Abrir comprovante</button>
        <button class="btn btn-ghost" id="btnOpenPdf">Abrir PDF</button>
      </div>

      <div class="row">
        <button class="btn btn-ok" id="btnWaCliente" ${waCli?'':'disabled title="Telefone do cliente vazio"'}>WhatsApp do cliente</button>
        <button class="btn btn-ok" id="btnWaFornecedor" ${waFor?'':'disabled title="Telefone do fornecedor vazio"'}>WhatsApp do fornecedor</button>
        <span style="flex:1"></span>
        <button class="btn btn-danger" id="btnClose">Fechar</button>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);

  wrap.querySelector('#btnOpenReceipt').onclick = ()=> window.open(receiptUrl, '_blank');
  wrap.querySelector('#btnOpenPdf').onclick     = ()=> window.open(pdfUrl, '_blank');
  wrap.querySelector('#btnClose').onclick       = ()=> wrap.remove();

  if (waCli)  wrap.querySelector('#btnWaCliente').onclick   = ()=> window.open(waCli, '_blank');
  if (waFor)  wrap.querySelector('#btnWaFornecedor').onclick= ()=> window.open(waFor, '_blank');
}

/* ======================== ENVIAR ================================ */
$id('enviar').onclick = async ()=>{
  const rom = Number($id('rom').value);
  const data = $id('data').value;
  const obs  = $id('obs').value.trim();

  const cliente = {
    tel: $id('cli_tel').value.trim(),
    nome: $id('cli_nome').value.trim(),
    local: $id('cli_local').value.trim()
  };
  const fornecedor = {
    tel: $id('for_tel').value.trim(),
    nome: $id('for_nome').value.trim(),
    local: $id('for_local').value.trim()
  };

  const itens = [];
  itensDiv.querySelectorAll('.grid').forEach(row=>{
    const [t,s,q] = row.querySelectorAll('select, input');
    const qtd = Number(q.value||0);
    if(qtd>0) itens.push({tipo:t.value,tamanho:s.value,qtd});
  });

  // valida√ß√µes m√≠nimas
  if(!rom){ showMsg('err','Informe o n√∫mero do ROM'); return }
  if(!data){ showMsg('err','Informe a data'); return }
  if(!cliente.tel || !cliente.nome || !cliente.local || !fornecedor.tel || !fornecedor.nome || !fornecedor.local){
    showMsg('err','Preencha os dados do cliente e fornecedor'); return
  }
  if(!itens.length){ showMsg('err','Adicione ao menos um item'); return }

  try{
    const body = {
      rom, data, obs,
      cliente, fornecedor,
      itens,
      fotos: fotosData.map(d=>({data:d}))
    };
    const r = await post('/rom/create', body);
    if(r.error){ showMsg('err', r.error); return }

    // Modal com 2 WhatsApps + links p√∫blicos
    openSuccessModal({
      cod: r.cod,
      receiptUrl: r.receiptUrl || r.htmlUrl || r.viewUrl || '',
      pdfUrl: r.pdfUrl || '',
      telCliente: cliente.tel,
      telFornecedor: fornecedor.tel
    });

    showMsg('ok', `Enviado! C√≥digo: ${r.cod}`);
  }catch(e){
    showMsg('err','Erro de rede: '+e);
  }
};
</script>
</body>
</html>
