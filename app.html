<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio â€¢ Painel</title>
  <style>
    :root{
      --bg:#0b1522; --panel:#0e1a2a; --card:#0f1d30; --muted:#8aa3c2; --txt:#eaf2ff;
      --primary:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --ring:rgba(59,130,246,.2);
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:500 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);position:sticky;top:0;z-index:3}
    .title{display:flex;gap:10px;align-items:center;font-weight:800}
    .muted{color:var(--muted)} .chip{padding:6px 10px;border-radius:999px;background:#0c1a2a;border:1px solid #1c2a40}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:12px;height:40px;padding:0 14px;font-weight:700}
    .btn.primary{background:var(--primary);color:white}
    .btn.ghost{background:transparent;border:1px solid #1d2a41;color:#d5e7ff}
    main{padding:18px;max-width:1100px;margin:auto}
    .card{background:var(--card);border:1px solid #15253b;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;color:#bfd3ef;margin:6px 0;display:block}
    input,select,textarea{width:100%;height:42px;border-radius:12px;border:1px solid transparent;background:#0d192a;color:var(--txt);padding:0 12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    .bar{height:4px;background:#0e1928;border-radius:999px;overflow:hidden;margin:12px 0 0;display:none}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--primary),#22c55e);transition:width .25s}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumbs img{height:78px;width:auto;border-radius:8px;border:1px solid #1d2a41}
    .items{display:grid;grid-template-columns:2fr 2fr 1fr auto;gap:10px;align-items:end}
    .tag{display:inline-flex;gap:8px;align-items:center}
  </style>
</head>
<body>

<header>
  <div class="title">
    <span>ðŸšš Romaneio</span>
    <span class="chip muted" id="who">â€¦</span>
  </div>
  <div style="display:flex;gap:8px">
    <button class="btn ghost" id="refresh">âŸ³ Atualizar</button>
    <button class="btn ghost" id="logout">Sair</button>
  </div>
</header>

<main>

  <!-- Cliente & Fornecedor -->
  <section class="card">
    <h3>Cliente & Fornecedor</h3>
    <div class="row">
      <div>
        <label>ROM</label>
        <input id="rom" placeholder="Ex.: 21" />
      </div>
      <div>
        <label>Data</label>
        <input id="data" type="date" />
      </div>

      <div>
        <label>Cliente â€¢ Telefone</label>
        <input id="cliTel" placeholder="(85) 9 8888-8888" />
      </div>
      <div>
        <label>Cliente â€¢ Nome</label>
        <input id="cliNome" placeholder="Nome do cliente" />
      </div>

      <div>
        <label>Cliente â€¢ Cidade/UF</label>
        <input id="cliCidade" placeholder="Fortaleza/CE" />
      </div>
      <div>
        <label>Fornecedor â€¢ Telefone</label>
        <input id="forTel" placeholder="(85) 3333-3333" />
      </div>

      <div>
        <label>Fornecedor â€¢ Nome</label>
        <input id="forNome" placeholder="Nome do fornecedor" />
      </div>
      <div>
        <label>Fornecedor â€¢ Cidade/UF</label>
        <input id="forCidade" placeholder="MaracanaÃº/CE" />
      </div>
    </div>
  </section>

  <!-- Itens -->
  <section class="card">
    <h3>Itens</h3>
    <div id="itens"></div>
    <div class="items" style="margin-top:10px">
      <div>
        <label>Tipo</label>
        <select id="tipo">
          <option>Caixa</option>
          <option>Saco</option>
          <option>Pallet</option>
          <option>Outro</option>
        </select>
      </div>
      <div>
        <label>Tamanho</label>
        <select id="tamanho">
          <option>P</option><option>M</option><option>G</option><option>GG</option>
        </select>
      </div>
      <div>
        <label>Qtd</label>
        <input id="qtd" type="number" min="1" value="1" />
      </div>
      <div>
        <button class="btn ghost" id="addItem">+ Adicionar item</button>
      </div>
    </div>
    <div class="muted" id="tot">Total: 0</div>
  </section>

  <!-- Fotos -->
  <section class="card">
    <h3>Fotos</h3>
    <input id="fotos" type="file" accept="image/*" multiple />
    <div class="thumbs" id="thumbs"></div>
  </section>

  <!-- Enviar -->
  <section class="card">
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn primary" id="enviar">Enviar Romaneio</button>
      <div class="tag muted" id="status">Pronto</div>
    </div>
    <div class="bar" id="bar"><i></i></div>
    <div class="muted" id="msg"></div>
  </section>

</main>

<script>
  // === CONFIG ===
  const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

  // === token: URL (?t=), sessionStorage, localStorage ===
  (function ensureToken(){
    const qs = new URLSearchParams(location.search);
    const urlT = qs.get('t');
    if (urlT) { localStorage.setItem('token', urlT); sessionStorage.setItem('token', urlT); }
  })();
  const TOKEN =
    new URLSearchParams(location.search).get('t') ||
    sessionStorage.getItem('token') ||
    localStorage.getItem('token') || '';

  // === helpers ===
  const $ = sel => document.querySelector(sel);
  const bar = $("#bar"), barFill = $("#bar>i");
  function loading(on=true){ bar.style.display = on?'block':'none'; requestAnimationFrame(()=> barFill.style.width = on?'95%':'0'); }
  function say(t){ $("#msg").textContent = t||''; }
  function setStatus(t){ $("#status").textContent = t; }

  async function post(path, body){
    const r = await fetch(API_BASE + "?path=" + encodeURIComponent(path), {
      method: "POST",
      headers: {"Content-Type":"application/json;charset=utf-8"},
      body: JSON.stringify(Object.assign({token:TOKEN}, body||{}))
    });
    return r.json();
  }

  // === sessÃ£o ===
  (async()=>{
    try{
      if(!TOKEN) throw new Error('sem-token');
      const w = await post("/whoami",{});
      if(!w.session) throw new Error('invalid');
      $("#who").textContent = `${w.session.usuario} â€¢ ${new Date(w.session.expira).toLocaleTimeString()}`;
    }catch(e){
      location.href = "index.html";
    }
  })();

  // === data default hoje ===
  (function setHoje(){
    const d=new Date();
    const iso = d.toISOString().slice(0,10);
    $("#data").value = iso;
  })();

  // === mÃ¡scara simples telefone ===
  function maskTel(el){
    el.addEventListener('input', ()=>{
      let v = el.value.replace(/\D/g,'').slice(0,11);
      if(v.length>2) v='('+v.slice(0,2)+') '+v.slice(2);
      if(v.length>10) v=v.slice(0,10)+'-'+v.slice(10);
      el.value=v;
    });
  }
  ["cliTel","forTel"].forEach(id=>maskTel($("#"+id)));

  // === itens ===
  const itens = [];
  function renderItens(){
    const c = $("#itens");
    c.innerHTML = itens.map(i=>`<div class="tag">â€¢ ${i.tipo} ${i.tamanho} â€” ${i.qtd}</div>`).join('')||'<span class="muted">Nenhum item</span>';
    $("#tot").textContent = "Total: " + itens.reduce((s,i)=>s+Number(i.qtd||0),0);
  }
  $("#addItem").onclick = ()=>{
    const it = {
      tipo: $("#tipo").value,
      tamanho: $("#tamanho").value,
      qtd: Number($("#qtd").value||0)
    };
    if(it.qtd>0) itens.push(it);
    renderItens();
  };
  renderItens();

  // === fotos preview -> base64 (data URLs) ===
  const fotos = [];
  $("#fotos").addEventListener('change', async (e)=>{
    fotos.length = 0; $("#thumbs").innerHTML = '';
    const files = Array.from(e.target.files||[]);
    for(const f of files){
      const b64 = await fileToDataURL(f);
      fotos.push({ dataUrl:b64 });
      const img = document.createElement('img'); img.src = b64; $("#thumbs").appendChild(img);
    }
  });
  function fileToDataURL(file){
    return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  }

  // === enviar ===
  $("#enviar").onclick = async ()=>{
    // validaÃ§Ãµes mÃ­nimas
    const rom = $("#rom").value.trim();
    const data = $("#data").value;
    const cliTel = $("#cliTel").value.trim();
    const cliNome = $("#cliNome").value.trim();
    const cliCidade = $("#cliCidade").value.trim();
    const forTel = $("#forTel").value.trim();
    const forNome = $("#forNome").value.trim();
    const forCidade = $("#forCidade").value.trim();

    if(!rom || !cliTel || !cliNome || !cliCidade || !forTel || !forNome || !forCidade){
      say("Preencha os dados de cliente e fornecedor."); return;
    }
    if(itens.length===0){ say("Adicione ao menos 1 item."); return; }

    const body = {
      rom, data,
      cliente:{ tel:cliTel, nome:cliNome, local:cliCidade },
      fornecedor:{ tel:forTel, nome:forNome, local:forCidade },
      itens, fotos
    };

    try{
      setStatus("Enviandoâ€¦"); loading(true); say('');
      const r = await post("/rom/create", body);
      if(r.error){ say("Erro: "+r.error); setStatus("Erro"); return; }

      setStatus("Enviado");
      say(`Romaneio ${r.cod} criado. PDF gerado.`);
      if(r.whatsappUrl){
        // abre pop de compartilhamento
        const ok = confirm("Abrir WhatsApp para enviar o comprovante?");
        if(ok) window.open(r.whatsappUrl, "_blank");
      }
      // limpar estado
      itens.length=0; renderItens(); $("#thumbs").innerHTML=''; $("#fotos").value='';
    }catch(e){
      setStatus("Erro"); say("Erro de rede: "+e.message);
    }finally{
      loading(false);
    }
  };

  // === aÃ§Ãµes topo ===
  $("#refresh").onclick = ()=> location.reload(true);
  $("#logout").onclick = ()=>{ localStorage.removeItem('token'); sessionStorage.removeItem('token'); location.href="index.html"; };
</script>
</body>
</html>
