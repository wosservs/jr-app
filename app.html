<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --chip:#111827;
      --bar:#60a5fa; --line:#1f2937;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#1d4ed8; --danger:#dc2626; --ok:#16a34a; --chip:#eef2ff;
      --bar:#3b82f6; --line:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 18px;z-index:10}
    nav a{color:var(--text);text-decoration:none;padding:10px 14px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .theme{background:transparent;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h2{margin:0 0 12px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--line);background:transparent;border-radius:10px;color:var(--text)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid4{display:grid;grid-template-columns:1.2fr .8fr .8fr 110px;gap:10px;align-items:center}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn-danger{background:var(--danger);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;border:0;background:var(--danger);color:#fff;cursor:pointer}
    .msg{margin-top:12px;padding:12px;border-radius:10px}
    .ok{background:#064e3b;color:#a7f3d0}
    .err{background:#7f1d1d;color:#fecaca}
    .topbar{position:fixed;inset:0 0 auto 0;height:3px;background:transparent;z-index:20}
    .bar{height:100%;width:0;background:var(--bar);transition:width .2s linear}
    .section{margin-bottom:16px}

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;max-width:520px;width:96%}
    .modal h3{margin:0 0 8px}
    .modal .row{justify-content:flex-end}
    .chip-ok{padding:2px 8px;border-radius:999px;background:#064e3b;color:#a7f3d0;font-size:12px}

    /* datalist ‚Äúgrande‚Äù para cidades */
    datalist option{color:#000}
  </style>
</head>
<body>
  <div class="topbar"><div id="bar" class="bar"></div></div>

  <header>
    <div class="row">
      <strong>üöö Romaneio</strong>
      <span id="who" class="muted"></span>
    </div>
    <nav class="row">
      <a href="#rom">Enviar Romaneio</a>
      <a href="#list">Romaneios</a>
      <a href="#clientes">Clientes</a>
      <a href="#users">Usu√°rios</a>
      <button id="btnTheme" class="theme">üåô/‚òÄÔ∏è</button>
      <a href="#" id="logout" class="btn-ghost">Sair</a>
    </nav>
  </header>

  <div class="container">
    <div class="card section" id="secRom">
      <h2>Enviar Romaneio</h2>

      <div class="grid2">
        <div>
          <label>ROM *</label>
          <input id="rom" type="number" placeholder="Ex.: 21" required>
        </div>
        <div>
          <label>Data *</label>
          <input id="data" type="date" required>
        </div>
      </div>

      <h3 class="muted" style="margin-top:12px">Cliente & Fornecedor</h3>
      <div class="grid2">
        <div>
          <label>Cliente ‚Ä¢ Telefone *</label>
          <input id="cli_tel" inputmode="numeric" placeholder="(85) 9 8888-8888" maxlength="16">
        </div>
        <div>
          <label>Cliente ‚Ä¢ Nome *</label>
          <input id="cli_nome" placeholder="Nome do cliente">
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Cliente ‚Ä¢ Cidade/UF *</label>
          <input id="cli_cidade_uf" list="listaCidades" placeholder="Fortaleza/CE">
        </div>
        <div class="row" style="align-items:end;gap:8px">
          <span id="cli_status" class="chip-ok" style="display:none">auto</span>
        </div>
      </div>

      <div class="grid2" style="margin-top:8px">
        <div>
          <label>Fornecedor ‚Ä¢ Telefone *</label>
          <input id="for_tel" inputmode="numeric" placeholder="(85) 3333-3333" maxlength="16">
        </div>
        <div>
          <label>Fornecedor ‚Ä¢ Nome *</label>
          <input id="for_nome" placeholder="Nome do fornecedor">
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Fornecedor ‚Ä¢ Cidade/UF *</label>
          <input id="for_cidade_uf" list="listaCidades" placeholder="Maracana√∫/CE">
        </div>
        <div class="row" style="align-items:end;gap:8px">
          <span id="for_status" class="chip-ok" style="display:none">auto</span>
        </div>
      </div>

      <label style="margin-top:8px">Obs.</label>
      <input id="obs" type="text" placeholder="Ex.: Doca 3, at√© 16h">

      <h3 class="muted" style="margin:14px 0 6px">Itens</h3>
      <div id="itens"></div>
      <div class="row" style="margin-top:8px">
        <button id="addItem" class="btn-ghost">+ Adicionar item</button>
        <span class="muted">Total: <b id="totalQtd">0</b></span>
      </div>

      <h3 class="muted" style="margin-top:12px">Fotos</h3>
      <input id="fotos" type="file" accept="image/*" capture="environment" multiple>
      <div id="thumbs" class="thumbs"></div>

      <div class="row" style="margin-top:14px">
        <button id="enviar" class="btn btn-primary">Enviar</button>
        <button id="limpar" class="btn btn-ghost">Limpar</button>
      </div>

      <div id="msg" style="display:none"></div>
    </div>

    <div class="card section">
      <h2>Romaneios</h2>
      <p class="muted">Lista/relat√≥rios numa pr√≥xima etapa.</p>
    </div>
  </div>

  <!-- datalist de cidades (preenchido via IBGE) -->
  <datalist id="listaCidades"></datalist>

  <!-- Modal ‚Äúcompletar cadastro‚Äù quando telefone n√£o encontrado -->
  <div id="modalCad" class="modal-back">
    <div class="modal">
      <h3>Cadastro n√£o encontrado</h3>
      <p class="muted" id="cadQuem">Preencha nome e cidade/UF.</p>
      <label>Nome</label>
      <input id="cadNome" placeholder="Nome">
      <label style="margin-top:8px">Cidade/UF</label>
      <input id="cadCidade" list="listaCidades" placeholder="Cidade/UF">
      <div class="row" style="margin-top:12px">
        <button id="cadCancel" class="btn btn-ghost">Cancelar</button>
        <button id="cadOk" class="btn btn-primary">Usar e cadastrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de sucesso com bot√µes de WhatsApp -->
  <div id="modalOk" class="modal-back">
    <div class="modal">
      <h3>Romaneio enviado com sucesso <span id="codChave" class="chip-ok"></span></h3>
      <p class="muted">Voc√™ pode abrir o PDF ou enviar pelo WhatsApp.</p>
      <div class="row">
        <button id="btnPdf" class="btn btn-ghost">Abrir PDF</button>
        <button id="btnWappCli" class="btn btn-primary">WhatsApp Cliente</button>
        <button id="btnWappFor" class="btn btn-primary">WhatsApp Fornecedor</button>
        <button id="btnOkClose" class="btn btn-ghost">Fechar</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
// URL da API atualizada com o seu link
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

/* ====== Infra UI ====== */
const $ = s => document.querySelector(s);
const bar = $('#bar');
function barStart(){ bar.style.width='20%'; let w=20; window._barInt=setInterval(()=>{w=Math.min(95,w+5); bar.style.width=w+'%'},200) }
function barDone(){ clearInterval(window._barInt); bar.style.width='100%'; setTimeout(()=>bar.style.width='0',300) }
function msg(kind, text){
  const el = $('#msg'); el.className = 'msg ' + (kind==='err'?'err':'ok');
  el.textContent = text; el.style.display='block';
}
function setTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t) }
(function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved){ setTheme(saved) } else { setTheme(window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark') }
})();
$('#btnTheme').onclick = ()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

function getAbsoluteUrl(page) {
    const currentUrl = window.location.href;
    const directoryPath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
    return directoryPath + page;
}

/* ====== Sess√£o ====== */
const sess = (function(){ try{return JSON.parse(localStorage.getItem('rom_session')||'{}')}catch(_){return{}} })();
if(!sess.token){ location.href = getAbsoluteUrl("index.html"); }
(async () => {
    try {
        const r = await post('/me', {});
        if (r.error) throw new Error(r.error);
        $('#who').textContent = r.me;
    } catch (e) {
        localStorage.removeItem('rom_session');
        location.href = getAbsoluteUrl("index.html");
    }
})();


/* ====== Logout ====== */
$('#logout').onclick = async (e)=>{ e.preventDefault(); try{ await post('/logout',{}) }catch(_){ } localStorage.removeItem('rom_session'); location.href= getAbsoluteUrl("index.html"); };

/* ====== Helpers ====== */
function onlyDigits(s){ return (s||'').replace(/\D+/g,'') }
function maskPhone(el){
  let d = onlyDigits(el.value).slice(0,11); // 10 ou 11
  if(d.length<=10){ // fixo (2+8)
    el.value = d.replace(/^(\d{0,2})(\d{0,4})(\d{0,4}).*/, (_,a,b,c)=> (a?`(${a}`:'') + (a&&a.length===2?') ':'') + (b||'') + (b&&c?'-':'') + (c||'') );
  }else{ // celular (2+9)
    el.value = d.replace(/^(\d{0,2})(\d{0,5})(\d{0,4}).*/, (_,a,b,c)=> (a?`(${a}`:'') + (a&&a.length===2?') ':'') + (b||'') + (b&&c?'-':'') + (c||'') );
  }
}
['#cli_tel','#for_tel'].forEach(sel=>{
  const el=$(sel); el.addEventListener('input',()=>maskPhone(el)); el.addEventListener('blur',()=>tryLookup(sel.includes('cli')?'cliente':'fornecedor'));
});

// Auto-preenchimento da data
$('#rom').addEventListener('input', (e) => {
  if (e.target.value.length > 0 && !$('#data').value) {
    $('#data').value = todayISO();
  }
});
// Busca por nome ao focar
$('#cli_nome').addEventListener('focus', () => tryLookup('cliente'));
$('#for_nome').addEventListener('focus', () => tryLookup('fornecedor'));

/* ====== API ====== */
async function post(path, body={}){
  return new Promise((resolve, reject) => {
    if(API_BASE.includes("COLE_A_URL")){
        return reject(new Error("Configure a URL da API na constante API_BASE."));
    }
    barStart();
    const xhr = new XMLHttpRequest();
    const url = API_BASE + "?path=" + encodeURIComponent(path);
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
    xhr.onload = function () {
        barDone();
        if (xhr.status >= 200 && xhr.status < 400) {
            try {
                resolve(JSON.parse(xhr.responseText));
            } catch(e) {
                reject(new Error("Erro ao processar resposta do servidor."));
            }
        } else {
            reject(new Error("HTTP " + xhr.status));
        }
    };
    xhr.onerror = () => {
        barDone();
        reject(new Error("Erro de conex√£o."));
    };
    xhr.send(JSON.stringify({...body, token:sess.token}));
  });
}

/* ====== Cidades (IBGE) ====== */
let cidades = []; // [{nome, uf, label}]
async function loadCidades(){
  try{
    const r = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/municipios?orderBy=nome');
    if (!r.ok) throw new Error(`IBGE API falhou com status ${r.status}`);
    const arr = await r.json();
    cidades = arr.map(x=>({nome:x.nome, uf:x.microrregiao.mesorregiao.UF.sigla, label:`${x.nome}/${x.microrregiao.mesorregiao.UF.sigla}`}));
    console.log(`${cidades.length} cidades carregadas.`);
  }catch(e){
    console.error("Falha ao carregar cidades do IBGE:", e);
  }
}
function fillDatalist(prefix){
  const dl = $('#listaCidades'); dl.innerHTML='';
  const p = (prefix||'').toLowerCase();
  const take = p.length>=3 ? cidades.filter(c=>c.label.toLowerCase().includes(p)).slice(0,50) : [];
  take.forEach(c=>{
    const o=document.createElement('option'); o.value=c.label; dl.appendChild(o);
  });
}
['#cli_cidade_uf','#for_cidade_uf','#cadCidade'].forEach(sel=>{
  const el=$(sel); el.addEventListener('input',()=>fillDatalist(el.value));
});
loadCidades();

/* ====== Itens ====== */
const tipos = ['Caixa','Saco','Palete','Outros'];
const tamanhos = ['P','M','G'];
const itensDiv = $('#itens');
const totalQtdEl = $('#totalQtd');
function somaTotal(){ let t=0; document.querySelectorAll('.qtd').forEach(i=> t += Number(i.value||0)); totalQtdEl.textContent = t; }
function itemRow(){
  const row = document.createElement('div');
  row.className='grid4';
  const selTipo = document.createElement('select'); tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTipo.appendChild(o) });
  const selTam  = document.createElement('select'); tamanhos.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; selTam.appendChild(o) });
  const qtd     = document.createElement('input');  qtd.type='number'; qtd.min='1'; qtd.value='1'; qtd.className='qtd'; qtd.oninput=somaTotal;
  const del     = document.createElement('button'); del.className='btn btn-danger'; del.textContent='x'; del.onclick=()=>{ row.remove(); somaTotal(); };
  row.appendChild(selTipo); row.appendChild(selTam); row.appendChild(qtd); row.appendChild(del);
  return row;
}
$('#addItem').onclick = ()=>{ itensDiv.appendChild(itemRow()); somaTotal(); };
itensDiv.appendChild(itemRow()); somaTotal();

/* ====== Fotos ====== */
const fileInput = $('#fotos'), thumbs=$('#thumbs'); let fotosData=[];
fileInput.onchange = async (ev)=>{
  const files = Array.from(ev.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const dataUrl = await fileToDataURL(f);
    fotosData.push(dataUrl);
  }
  renderThumbs();
};
function renderThumbs(){
  thumbs.innerHTML='';
  fotosData.forEach((d,i)=>{
    const box=document.createElement('div'); box.className='thumb';
    const img=new Image(); img.src=d; box.appendChild(img);
    const x=document.createElement('button'); x.textContent='√ó'; x.onclick=()=>{ fotosData.splice(i,1); renderThumbs(); };
    box.appendChild(x); thumbs.appendChild(box);
  });
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ====== Form helpers ====== */
// CORRE√á√ÉO: Usa a data local para evitar problemas de fuso hor√°rio.
function todayISO() {
  const d = new Date();
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

$('#limpar').onclick = clearForm;
function clearForm(){
  $('#rom').value=''; $('#obs').value=''; $('#data').value = '';
  ['#cli_tel','#cli_nome','#cli_cidade_uf','#for_tel','#for_nome','#for_cidade_uf'].forEach(s=>$(s).value='');
  itensDiv.innerHTML=''; itensDiv.appendChild(itemRow()); somaTotal();
  fileInput.value=''; fotosData=[]; renderThumbs();
  $('#msg').style.display='none';
}

/* ====== Lookup por telefone ====== */
let pendenteCadastro = {cliente:false, fornecedor:false};
async function tryLookup(tipo){
  const telEl = tipo==='cliente' ? $('#cli_tel') : $('#for_tel');
  const nomeEl = tipo==='cliente' ? $('#cli_nome') : $('#for_nome');
  const cidEl  = tipo==='cliente' ? $('#cli_cidade_uf') : $('#for_cidade_uf');
  const chip   = tipo==='cliente' ? $('#cli_status') : $('#for_status');
  const tel = onlyDigits(telEl.value);
  chip.style.display='none';
  if(tel.length<10) return;

  try{
    const r = await post('/contacts/find', { tipo, tel });
    if(r && r.found){
      if(r.nome) nomeEl.value = r.nome;
      if(r.cidade_uf) cidEl.value = r.cidade_uf;
      chip.textContent='auto'; chip.style.display='inline-block';
      (tipo==='cliente') ? pendenteCadastro.cliente=false : pendenteCadastro.fornecedor=false;
      return;
    }
    // n√£o encontrado ‚Üí pedir nome/cidade
    await abrirModalCadastro(tipo, nomeEl.value, cidEl.value);
  }catch(e){
    console.error(`Falha ao buscar contato (${tipo}):`, e);
  }
}
function abrirModalCadastro(tipo, nomeAtual, cidAtual){
  return new Promise(res=>{
    $('#cadQuem').textContent = `Cadastro de ${tipo} n√£o encontrado.`;
    $('#cadNome').value = nomeAtual||'';
    $('#cadCidade').value = cidAtual||'';
    $('#modalCad').style.display='flex';
    $('#cadCancel').onclick = ()=>{ $('#modalCad').style.display='none'; res(false) };
    $('#cadOk').onclick = ()=>{
      const nome = $('#cadNome').value.trim();
      const cidade = $('#cadCidade').value.trim();
      if(tipo==='cliente'){ $('#cli_nome').value=nome; $('#cli_cidade_uf').value=cidade; pendenteCadastro.cliente=true; }
      else { $('#for_nome').value=nome; $('#for_cidade_uf').value=cidade; pendenteCadastro.fornecedor=true; }
      $('#modalCad').style.display='none';
      res(true);
    };
  });
}

/* ====== Enviar ====== */
$('#enviar').onclick = async ()=>{
  const rom = Number($('#rom').value);
  const data = $('#data').value;
  const obs  = $('#obs').value.trim();

  const cli_tel  = $('#cli_tel').value.trim();
  const cli_nome = $('#cli_nome').value.trim();
  const cli_cid  = $('#cli_cidade_uf').value.trim();

  const for_tel  = $('#for_tel').value.trim();
  const for_nome = $('#for_nome').value.trim();
  const for_cid  = $('#for_cidade_uf').value.trim();

  const itens = [];
  itensDiv.querySelectorAll('.grid4').forEach(row=>{
    const [t,s,q] = row.querySelectorAll('select, input');
    const qtd = Number(q.value||0);
    if(qtd>0) itens.push({tipo:t.value,tamanho:s.value,qtd});
  });

  // valida√ß√µes
  if(!rom || !data || !cli_tel || !cli_nome || !cli_cid || !for_tel || !for_nome || !for_cid){ msg('err','Campos obrigat√≥rios ausentes'); return }
  if(!itens.length){ msg('err','Adicione ao menos um item'); return }

  try{
    const body = {
      rom, data, obs,
      cliente: {tel:cli_tel, nome:cli_nome, local:cli_cid, cadastrar:pendenteCadastro.cliente},
      fornecedor: {tel:for_tel, nome:for_nome, local:for_cid, cadastrar:pendenteCadastro.fornecedor},
      itens,
      fotos: fotosData.map(d=>({data:d}))
    };
    const r = await post('/rom/create', body);
    if(r.error){ msg('err', r.error); return }

    // Mostra modal de sucesso
    const codigo = r.cod || r.codigo || r.id || '';
    $('#codChave').textContent = `cod ${codigo}`;
    const pdfUrl = r.pdfUrl || r.pdf || r.driveUrl || '';
    $('#btnPdf').onclick = ()=>{ if(pdfUrl) window.open(pdfUrl,'_blank') };

    const wmsg = (alvo) => {
      const tel = onlyDigits(alvo==='cli' ? cli_tel : for_tel);
      if(!tel){ return }
      const texto = `Romaneio ${rom} (cod ${codigo})%0ACliente: ${cli_nome}%0AFornecedor: ${for_nome}%0AData: ${data}%0AItens: ${itens.map(i=>`${i.qtd} ${i.tipo} ${i.tamanho}`).join(', ')}${pdfUrl?`%0AComprovante: ${pdfUrl}`:''}`;
      window.open(`https://wa.me/55${tel}?text=${texto}`,'_blank');
    };
    $('#btnWappCli').onclick = ()=>wmsg('cli');
    $('#btnWappFor').onclick = ()=>wmsg('for');
    $('#modalOk').style.display='flex';
    $('#btnOkClose').onclick = ()=>{ $('#modalOk').style.display='none'; };

    // limpa form para novo envio
    clearForm();
    msg('ok', `Enviado! C√≥digo: ${codigo}`);
  }catch(e){
    msg('err','Erro de rede: '+e);
  }
};
</script>

</body>
</html>

