<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --chip:#111827; --bar:#60a5fa;
      --line:#1f2937; --overlay:rgba(15,23,42,.65);
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --primary:#1d4ed8; --danger:#dc2626; --ok:#16a34a; --chip:#eef2ff; --bar:#3b82f6;
      --line:#e5e7eb; --overlay:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 18px;z-index:10}
    nav a{color:var(--text);text-decoration:none;padding:10px 14px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .theme{background:transparent;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h2{margin:0 0 12px}
    select,input[type=text],input[type=number],input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--line);background:transparent;border-radius:10px;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:10px;align-items:center}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn-danger{background:var(--danger);color:#fff}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;border:0;background:var(--danger);color:#fff;cursor:pointer}
    .msg{margin-top:12px;padding:12px;border-radius:10px}
    .ok{background:#064e3b;color:#a7f3d0}
    .err{background:#7f1d1d;color:#fecaca}
    .topbar{position:fixed;inset:0 0 auto 0;height:3px;background:transparent;z-index:20}
    .bar{height:100%;width:0;background:var(--bar);transition:width .2s linear}
    .section{margin-bottom:16px}
    /* Modal sucesso */
    .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;max-width:520px;width:92%}
    .modal h3{margin:0 0 8px}
    .modal .row{justify-content:flex-end}
    .tag{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);margin-left:8px}
    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:var(--card);border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none;z-index:60}
  </style>
</head>
<body>
  <div class="topbar"><div id="bar" class="bar"></div></div>

  <header>
    <div class="row">
      <strong>üöö Romaneio</strong>
      <span id="who" class="muted"></span>
    </div>
    <nav class="row">
      <a href="#rom" id="mRom">Enviar Romaneio</a>
      <a href="#list">Romaneios</a>
      <a href="#clientes">Clientes</a>
      <a href="#users">Usu√°rios</a>
      <button id="btnTheme" class="theme">üåô/‚òÄÔ∏è</button>
      <a href="#" id="logout" class="btn-ghost">Sair</a>
    </nav>
  </header>

  <div class="container">
    <div class="card section" id="secRom">
      <h2>Enviar Romaneio</h2>

      <div class="row">
        <div style="flex:1">
          <label class="muted">ROM *</label>
          <input id="rom" type="number" placeholder="Ex.: 21">
        </div>
        <div style="flex:1">
          <label class="muted">Data *</label>
          <input id="data" type="date">
        </div>
      </div>

      <h3 class="muted" style="margin-top:10px">Cliente & Fornecedor</h3>

      <div class="row">
        <div style="flex:1">
          <label class="muted">Cliente ‚Ä¢ Telefone *</label>
          <input id="cli_tel" type="text" placeholder="(85) 9 9999-9999" inputmode="numeric" maxlength="16">
        </div>
        <div style="flex:1">
          <label class="muted">Cliente ‚Ä¢ Nome *</label>
          <input id="cli_nome" type="text" placeholder="Nome do cliente">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="muted">Cliente ‚Ä¢ Cidade/UF *</label>
          <input id="cli_cid" type="text" placeholder="Fortaleza/CE" list="dlCidades">
        </div>
        <div style="flex:1">
          <label class="muted">Fornecedor ‚Ä¢ Telefone *</label>
          <input id="for_tel" type="text" placeholder="(85) 3333-3333" inputmode="numeric" maxlength="16">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="muted">Fornecedor ‚Ä¢ Cidade/UF *</label>
          <input id="for_cid" type="text" placeholder="Maracana√∫/CE" list="dlCidades">
        </div>
        <div style="flex:1">
          <label class="muted">Fornecedor ‚Ä¢ Nome *</label>
          <input id="for_nome" type="text" placeholder="Nome do fornecedor">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="muted">Obs.</label>
          <input id="obs" type="text" placeholder="Ex.: Doca 3, at√© 16h">
        </div>
      </div>

      <h3 class="muted" style="margin-top:12px">Itens</h3>
      <div id="itens"></div>
      <div class="row" style="margin-top:8px">
        <button id="addItem" class="btn-ghost">+ Adicionar item</button>
        <span class="muted">Total: <b id="totalQtd">0</b></span>
      </div>

      <h3 class="muted" style="margin-top:12px">Fotos</h3>
      <input id="fotos" type="file" accept="image/*" capture="environment" multiple>
      <div id="thumbs" class="thumbs"></div>

      <div class="row" style="margin-top:14px">
        <button id="enviar" class="btn btn-primary">Enviar</button>
        <button id="limpar" class="btn btn-ghost">Limpar</button>
      </div>

      <div id="msg" style="display:none"></div>
    </div>

    <div class="card section">
      <h2>Romaneios</h2>
      <p class="muted">Lista/relat√≥rios numa pr√≥xima etapa.</p>
    </div>
  </div>

  <datalist id="dlCidades"></datalist>

  <div id="okLayer" class="overlay">
    <div class="modal">
      <h3>Romaneio enviado com sucesso <span id="okCod" class="tag"></span></h3>
      <p class="muted" id="okTxt">Voc√™ pode abrir o PDF ou enviar pelo WhatsApp.</p>
      <div class="row">
        <a id="okPdf" href="#" target="_blank" class="btn btn-ghost">Abrir PDF</a>
        <a id="okWa"  href="#" target="_blank" class="btn btn-primary">Enviar no WhatsApp</a>
        <button id="okClose" class="btn">Fechar</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

/* ====== Barra ====== */
const bar = document.getElementById('bar');
function barStart(){ bar.style.width='20%'; let w=20; window._barInt=setInterval(()=>{w=Math.min(95,w+5); bar.style.width=w+'%'},200)}
function barDone(){ clearInterval(window._barInt); bar.style.width='100%'; setTimeout(()=>bar.style.width='0',300)}

/* ====== Tema ====== */
function setTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t) }
(function(){ const s=localStorage.getItem('theme'); setTheme(s?s:(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark')) })();
document.getElementById('btnTheme').onclick=()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* ====== Sess√£o ====== */
const sess=(function(){try{return JSON.parse(localStorage.getItem('session')||localStorage.getItem('rom_session')||'{}')}catch(_){return{}}})();
if(!sess.token){ location.href='index.html'; }
document.getElementById('who').textContent = (sess.usuario||'') ? `${sess.usuario} ¬∑ ${(sess.role||'')}` : '';

/* ====== Toast ====== */
function toast(text, kind='ok'){
  const el=document.getElementById('toast');
  el.textContent=text; el.style.display='block';
  el.style.borderColor=(kind==='err'?'#b91c1c': 'var(--line)');
  setTimeout(()=>{ el.style.display='none' }, 2400);
}

/* ====== Helpers ====== */
function showMsg(kind, text){ const el=document.getElementById('msg'); el.className='msg '+(kind==='err'?'err':'ok'); el.textContent=text; el.style.display='block'; }
async function post(path, body={}){
  barStart();
  try{
    const r = await fetch(API_BASE+"?path="+encodeURIComponent(path), {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({...body, token:sess.token})
    });
    barDone();
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }catch(e){ barDone(); throw e }
}

/* ====== Logout ====== */
document.getElementById('logout').onclick = async (e)=>{
  e.preventDefault();
  try{ await post('/logout',{}); }catch(_){}
  localStorage.removeItem('session'); localStorage.removeItem('rom_session');
  location.href='index.html';
};

/* ====== Itens ====== */
const tipos=['Caixa','Saco','Palete','Outros'];
const tamanhos=['P','M','G'];
const itensDiv=document.getElementById('itens');
const totalQtdEl=document.getElementById('totalQtd');
function somaTotal(){ let t=0; document.querySelectorAll('.qtd').forEach(i=> t += Number(i.value||0)); totalQtdEl.textContent=t; }
function itemRow(){
  const row=document.createElement('div'); row.className='grid';
  const selTipo=document.createElement('select'); tipos.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;selTipo.appendChild(o)});
  const selTam=document.createElement('select'); tamanhos.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;selTam.appendChild(o)});
  const qtd=document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='1'; qtd.className='qtd'; qtd.oninput=somaTotal;
  const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='X'; del.onclick=()=>{ row.remove(); somaTotal(); };
  row.appendChild(selTipo); row.appendChild(selTam); row.appendChild(qtd); row.appendChild(del); return row;
}
document.getElementById('addItem').onclick=()=>{ itensDiv.appendChild(itemRow()); somaTotal(); };
itensDiv.appendChild(itemRow()); somaTotal();

/* ====== Fotos (compress√£o) ====== */
const fileInput=document.getElementById('fotos');
const thumbs=document.getElementById('thumbs');
let fotosData=[]; // dataURL JPG comprimida
fileInput.onchange = async (ev)=>{
  const files=Array.from(ev.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const dataUrl = await fileToDataURL(f);
    const small   = await compressImage(dataUrl, 1600, 0.82); // m√°x 1600px, qualidade 82%
    fotosData.push(small);
  }
  renderThumbs();
};
function renderThumbs(){
  thumbs.innerHTML='';
  fotosData.forEach((d,i)=>{
    const box=document.createElement('div'); box.className='thumb';
    const img=new Image(); img.src=d; box.appendChild(img);
    const x=document.createElement('button'); x.textContent='√ó'; x.onclick=()=>{ fotosData.splice(i,1); renderThumbs(); };
    box.appendChild(x);
    thumbs.appendChild(box);
  });
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function compressImage(dataUrl, maxSide=1600, quality=0.82){
  return new Promise((resolve)=>{
    const img=new Image(); img.onload=()=>{
      let {width:w,height:h}=img;
      const ratio=Math.min(1, maxSide/Math.max(w,h));
      if(ratio<1){ w=Math.round(w*ratio); h=Math.round(h*ratio); }
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const cx=c.getContext('2d'); cx.drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    }; img.src=dataUrl;
  });
}

/* ====== Data default ====== */
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10) }
document.getElementById('data').value=todayISO();

/* ====== M√°scara telefone ====== */
function digits(s){ return String(s||'').replace(/\D/g,'') }
function maskPhone(el){
  el.addEventListener('input', ()=>{
    let v=digits(el.value).replace(/^55/,''); if(v.length>11) v=v.slice(0,11);
    if(v.length>=11){ el.value=`(${v.slice(0,2)}) ${v.slice(2,3)} ${v.slice(3,7)}-${v.slice(7)}`; }
    else if(v.length>=10){ el.value=`(${v.slice(0,2)}) ${v.slice(2,6)}-${v.slice(6)}`; }
    else if(v.length>=6){ el.value=`(${v.slice(0,2)}) ${v.slice(2,6)}-${v.slice(6)}`; }
    else if(v.length>=2){ el.value=`(${v.slice(0,2)}) ${v.slice(2)}`; }
    else { el.value=v; }
  });
}
maskPhone(document.getElementById('cli_tel'));
maskPhone(document.getElementById('for_tel'));

/* ====== Autocomplete Cidades (IBGE) ====== */
let _cidadesBR=null; const $dl=document.getElementById('dlCidades');
async function ensureCidadesBR(){
  if(_cidadesBR) return _cidadesBR;
  const cache=localStorage.getItem('cidadesBR_v1'); if(cache){ _cidadesBR=JSON.parse(cache); return _cidadesBR; }
  const r=await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/municipios');
  const js=await r.json();
  _cidadesBR=js.map(m=>`${m.nome}/${m.microrregiao.mesorregiao.UF.sigla}`);
  localStorage.setItem('cidadesBR_v1', JSON.stringify(_cidadesBR)); return _cidadesBR;
}
function bindCityAutocomplete(input){
  input.setAttribute('list','dlCidades');
  let last=''; input.addEventListener('input', async ()=>{
    const v=input.value.trim().toLowerCase(); if(v.length<3||v===last) return; last=v;
    const list=await ensureCidadesBR(); const matches=list.filter(c=>c.toLowerCase().includes(v)).slice(0,40);
    $dl.innerHTML=matches.map(c=>`<option value="${c}">`).join('');
  });
}
bindCityAutocomplete(document.getElementById('cli_cid'));
bindCityAutocomplete(document.getElementById('for_cid'));

/* ====== Limpar ====== */
document.getElementById('limpar').onclick=()=>{
  ['rom','obs','cli_tel','cli_nome','cli_cid','for_tel','for_nome','for_cid'].forEach(id=>document.getElementById(id).value='');
  itensDiv.innerHTML=''; itensDiv.appendChild(itemRow()); somaTotal();
  fileInput.value=''; fotosData=[]; renderThumbs();
  document.getElementById('msg').style.display='none';
  document.getElementById('data').value=todayISO();
};

/* ====== Enviar ====== */
document.getElementById('enviar').onclick=async ()=>{
  const rom=Number(document.getElementById('rom').value);
  const data=document.getElementById('data').value;
  const obs =document.getElementById('obs').value.trim();
  const cli_tel =document.getElementById('cli_tel').value.trim();
  const cli_nome=document.getElementById('cli_nome').value.trim();
  const cli_cid =document.getElementById('cli_cid').value.trim();
  const for_tel =document.getElementById('for_tel').value.trim();
  const for_nome=document.getElementById('for_nome').value.trim();
  const for_cid =document.getElementById('for_cid').value.trim();

  const itens=[]; itensDiv.querySelectorAll('.grid').forEach(row=>{
    const [t,s,q]=row.querySelectorAll('select, input'); const qtd=Number(q.value||0);
    if(qtd>0) itens.push({tipo:t.value,tamanho:s.value,qtd});
  });

  if(!rom||!data||!cli_tel||!cli_nome||!cli_cid||!for_tel||!for_nome||!for_cid||!itens.length){
    showMsg('err','Campos obrigat√≥rios ausentes'); return;
  }

  // Corta se payload ficar absurdo (> ~8MB) para evitar ‚ÄúFailed to fetch‚Äù
  const approxBytes = fotosData.reduce((n,d)=>n + (d.length*3/4), 0);
  if(approxBytes > 8*1024*1024){ showMsg('err','Fotos muito pesadas. Selecione menos ou imagens menores.'); return; }

  try{
    const body={
      rom,data,obs,
      cliente:{tel:cli_tel,nome:cli_nome,local:cli_cid},
      fornecedor:{tel:for_tel,nome:for_nome,local:for_cid},
      itens,
      fotos:fotosData.map(d=>({data:d}))
    };
    const r=await post('/rom/create', body);
    if(r.error){ showMsg('err', r.error); return; }

    // Sucesso ‚Üí toast + modal
    toast('Romaneio enviado!');
    showMsg('ok', `Enviado! C√≥digo: ${r.cod}`);
    document.getElementById('okCod').textContent=`cod ${r.cod}`;
    if(r.pdfUrl)      document.getElementById('okPdf').href=r.pdfUrl;
    // Se backend n√£o mandar whatsappUrl, geramos com o telefone do cliente:
    const wa = r.whatsappUrl || `https://wa.me/55${(cli_tel||'').replace(/\D/g,'')}?text=${encodeURIComponent('Segue o comprovante do romaneio '+r.cod)}`;
    document.getElementById('okWa').href=wa;
    document.getElementById('okLayer').style.display='flex';

  }catch(e){
    showMsg('err','Erro de rede: '+e.message);
  }
};

/* Modal close */
document.getElementById('okClose').onclick=()=>{document.getElementById('okLayer').style.display='none';};
document.getElementById('okLayer').addEventListener('click',(e)=>{if(e.target.id==='okLayer') e.currentTarget.style.display='none';});
</script>
</body>
</html>
