<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    :root{
      --bg:#0f172a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --chip:#111827; --bar:#60a5fa;
      --line:#1f2937;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#1d4ed8; --danger:#dc2626; --ok:#16a34a; --chip:#eef2ff; --bar:#3b82f6;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 18px;z-index:10}
    nav a{color:var(--text);text-decoration:none;padding:10px 14px;border-radius:999px;background:var(--chip);border:1px solid var(--line)}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    .theme{background:transparent;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h2{margin:0 0 12px}
    select,input[type=text],input[type=number],input[type=date],textarea{width:100%;padding:10px 12px;border:1px solid var(--line);background:transparent;border-radius:10px;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:10px;align-items:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn-danger{background:var(--danger);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;border:0;background:var(--danger);color:#fff;cursor:pointer}
    .msg{margin-top:10px;padding:10px;border-radius:10px}
    .ok{background:#064e3b;color:#a7f3d0}
    .err{background:#7f1d1d;color:#fecaca}
    .topbar{position:fixed;inset:0 0 auto 0;height:3px;background:transparent;z-index:20}
    .bar{height:100%;width:0;background:var(--bar);transition:width .2s linear}
    .section{margin-bottom:16px}

    /* autocomplete */
    .ac-wrap{position:relative}
    .ac-list{
      position:absolute; inset:auto 0 0 0; transform:translateY(100%);
      background:var(--card); border:1px solid var(--line); border-radius:10px;
      padding:6px; margin-top:4px; max-height:220px; overflow:auto; z-index:5; display:none;
    }
    .ac-item{padding:8px;border-radius:8px;cursor:pointer}
    .ac-item:hover{background:var(--chip)}
    .req::after{content:" *"; color:#f87171; font-weight:700}
  </style>
</head>
<body>
  <div class="topbar"><div id="bar" class="bar"></div></div>

  <header>
    <div class="row">
      <strong>üöö Romaneio</strong>
      <span id="who" class="muted"></span>
    </div>
    <nav class="row">
      <a href="#rom" id="mRom">Enviar Romaneio</a>
      <a href="#list">Romaneios</a>
      <a href="#clientes">Clientes</a>
      <a href="#users">Usu√°rios</a>
      <button id="btnTheme" class="theme">üåô/‚òÄÔ∏è</button>
      <a href="#" id="logout" class="btn-ghost">Sair</a>
    </nav>
  </header>

  <div class="container">
    <div class="card section" id="secRom">
      <h2>Enviar Romaneio</h2>

      <div class="grid-2">
        <div>
          <label class="muted req">ROM</label>
          <input id="rom" type="number" placeholder="Ex.: 21">
        </div>
        <div>
          <label class="muted req">Data</label>
          <input id="data" type="date">
        </div>
      </div>

      <!-- CLIENTE & FORNECEDOR -->
      <h3 class="muted" style="margin-top:14px">Cliente & Fornecedor</h3>

      <div class="grid-2">
        <div>
          <label class="muted req">Cliente ‚Ä¢ Telefone</label>
          <input id="cliTel" type="text" inputmode="numeric" placeholder="(85) 9 9999-9999">
        </div>
        <div>
          <label class="muted req">Cliente ‚Ä¢ Nome</label>
          <input id="cliNome" type="text" placeholder="Nome do cliente">
        </div>
      </div>

      <div class="grid-2">
        <div class="ac-wrap">
          <label class="muted req">Cliente ‚Ä¢ Cidade/UF</label>
          <input id="cliCidade" type="text" placeholder="Fortaleza/CE" autocomplete="off">
          <div id="cliCidadeList" class="ac-list"></div>
        </div>
        <div>
          <label class="muted req">Fornecedor ‚Ä¢ Telefone</label>
          <input id="forTel" type="text" inputmode="numeric" placeholder="(85) 3333-3333">
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label class="muted req">Fornecedor ‚Ä¢ Nome</label>
          <input id="forNome" type="text" placeholder="Nome do fornecedor">
        </div>
        <div class="ac-wrap">
          <label class="muted req">Fornecedor ‚Ä¢ Cidade/UF</label>
          <input id="forCidade" type="text" placeholder="Maracana√∫/CE" autocomplete="off">
          <div id="forCidadeList" class="ac-list"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="muted">Obs.</label>
        <input id="obs" type="text" placeholder="Ex.: Doca 3, at√© 16h">
      </div>

      <h3 class="muted" style="margin-top:12px">Itens</h3>
      <div id="itens"></div>
      <div class="row" style="margin-top:8px">
        <button id="addItem" class="btn-ghost">+ Adicionar item</button>
        <span class="muted">Total: <b id="totalQtd">0</b></span>
      </div>

      <h3 class="muted" style="margin-top:12px">Fotos</h3>
      <input id="fotos" type="file" accept="image/*" capture="environment" multiple>
      <div id="thumbs" class="thumbs"></div>

      <div class="row" style="margin-top:14px">
        <button id="enviar" class="btn btn-primary">Enviar</button>
        <button id="limpar" class="btn btn-ghost">Limpar</button>
      </div>

      <div id="msg" style="display:none"></div>
    </div>

    <div class="card section">
      <h2>Romaneios</h2>
      <p class="muted">Lista/relat√≥rios numa pr√≥xima etapa.</p>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

/* ===== Barra de progresso ===== */
const bar = document.getElementById('bar');
function barStart(){ bar.style.width='20%'; let w=20; window._barInt=setInterval(()=>{w=Math.min(95,w+5); bar.style.width=w+'%'},200)}
function barDone(){ clearInterval(window._barInt); bar.style.width='100%'; setTimeout(()=>bar.style.width='0',300)}

/* ===== Tema ===== */
function setTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t) }
(function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved){ setTheme(saved) } else { setTheme(window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark') }
})();
document.getElementById('btnTheme').onclick = ()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* ===== Sess√£o ===== */
function getCookie(name){ const m = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)')); return m? decodeURIComponent(m[2]) : null; }
function getTokenFromHash(){ const h = location.hash || ''; const m = h.match(/[#&]t=([^&]+)/); return m? decodeURIComponent(m[1]) : null; }
function getSession(){
  let s=null; try{s=JSON.parse(localStorage.getItem('rom_session')||'null')}catch(_){}
  if(!s||!s.token){ try{s=JSON.parse(localStorage.getItem('session')||'null')}catch(_){} }
  const tHash=getTokenFromHash(); if(!s) s={}; if(tHash) s.token=tHash; if(!s.token) s.token=getCookie('rom_token'); return s||{};
}
const sess=getSession();
if(!sess||!sess.token){ alert('Sess√£o inv√°lida. Fa√ßa login.'); location.href='index.html'; }
document.getElementById('who').textContent = (sess.usuario||'') ? `${sess.usuario} ¬∑ ${(sess.role||'')}` : '';

/* ===== Helpers ===== */
function showMsg(kind, text){
  const el=document.getElementById('msg');
  el.className='msg '+(kind==='err'?'err':'ok');
  el.textContent=text;
  el.style.display='block';
}
async function post(path, body={}){
  barStart();
  try{
    const r=await fetch(API_BASE+"?path="+encodeURIComponent(path),{
      method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify({...body, token:sess.token})
    });
    barDone();
    return await r.json();
  }catch(e){ barDone(); throw e }
}

/* ===== Logout ===== */
document.getElementById('logout').onclick = async (e)=>{
  e.preventDefault();
  try{ await post('/logout',{});}catch(_){}
  localStorage.removeItem('rom_session'); localStorage.removeItem('session');
  document.cookie="rom_token=; path=/; max-age=0";
  location.href='index.html';
};

/* ===== Itens ===== */
const tipos=['Caixa','Saco','Palete','Outros'];
const tamanhos=['P','M','G'];
const itensDiv=document.getElementById('itens'); const totalQtdEl=document.getElementById('totalQtd');
function somaTotal(){ let t=0; document.querySelectorAll('.qtd').forEach(i=> t+=Number(i.value||0)); totalQtdEl.textContent=t; }
function itemRow(){
  const row=document.createElement('div'); row.className='grid';
  const selTipo=document.createElement('select'); tipos.forEach(t=>{ const o=document.createElement('option'); o.value=t;o.textContent=t; selTipo.appendChild(o) });
  const selTam=document.createElement('select'); tamanhos.forEach(t=>{ const o=document.createElement('option'); o.value=t;o.textContent=t; selTam.appendChild(o) });
  const qtd=document.createElement('input'); qtd.type='number'; qtd.min='1'; qtd.value='1'; qtd.className='qtd'; qtd.oninput=somaTotal;
  const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='x'; del.onclick=()=>{row.remove();somaTotal();}
  row.appendChild(selTipo); row.appendChild(selTam); row.appendChild(qtd); row.appendChild(del);
  return row;
}
document.getElementById('addItem').onclick=()=>{ itensDiv.appendChild(itemRow()); somaTotal(); };
itensDiv.appendChild(itemRow()); somaTotal();

/* ===== Fotos ===== */
const fileInput=document.getElementById('fotos'); const thumbs=document.getElementById('thumbs'); let fotosData=[];
fileInput.onchange=async(ev)=>{ const files=Array.from(ev.target.files||[]); for(const f of files){ if(!f.type.startsWith('image/')) continue; const d=await fileToDataURL(f); fotosData.push(d);} renderThumbs(); };
function renderThumbs(){ thumbs.innerHTML=''; fotosData.forEach((d,i)=>{ const box=document.createElement('div'); box.className='thumb'; const img=new Image(); img.src=d; box.appendChild(img); const x=document.createElement('button'); x.textContent='√ó'; x.onclick=()=>{ fotosData.splice(i,1); renderThumbs(); }; box.appendChild(x); thumbs.appendChild(box); }); }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ===== Data hoje ===== */
function todayISO(){ const d=new Date(); const tz=new Date(d.getTime()-d.getTimezoneOffset()*60000); return tz.toISOString().slice(0,10) }
document.getElementById('data').value=todayISO();

/* ===== M√°scara de telefone BR ===== */
function formatBRPhone(v){
  const nums=(v||'').replace(/\D+/g,'').slice(0,11); // DDI removido, at√© 11 d√≠gitos
  if(nums.length<=2) return `(${nums}`;
  if(nums.length<=6) return `(${nums.slice(0,2)}) ${nums.slice(2)}`;
  if(nums.length===10) return `(${nums.slice(0,2)}) ${nums.slice(2,6)}-${nums.slice(6)}`; // fixo
  // celular 11 d√≠gitos
  return `(${nums.slice(0,2)}) ${nums.slice(2,7)}-${nums.slice(7)}`;
}
['cliTel','forTel'].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('input',()=>{ const start=el.selectionStart; el.value=formatBRPhone(el.value); });
});

/* ===== Autocomplete Cidade/UF ===== */
const CITY_LIST=[
  'Fortaleza/CE','Maracana√∫/CE','Maracana√∫/CE','Caucaia/CE','Eus√©bio/CE','Aquiraz/CE','Itaitinga/CE',
  'Pacatuba/CE','Horizonte/CE','Pacajus/CE','Maranguape/CE','Sobral/CE','Juazeiro do Norte/CE',
  'Crato/CE','Iguatu/CE','Quixad√°/CE','Russas/CE','Aracati/CE'
];
function bindAutocomplete(inputId, listId){
  const input=document.getElementById(inputId);
  const list=document.getElementById(listId);
  function close(){ list.style.display='none'; }
  function open(){ list.style.display='block'; }
  input.addEventListener('input', ()=>{
    const q=(input.value||'').trim().toLowerCase();
    if(q.length<3){ close(); return; }
    list.innerHTML='';
    const hits=CITY_LIST.filter(c=>c.toLowerCase().includes(q)).slice(0,30);
    if(!hits.length){ close(); return; }
    hits.forEach(c=>{
      const item=document.createElement('div'); item.className='ac-item'; item.textContent=c;
      item.onmousedown=(e)=>{ e.preventDefault(); input.value=c; close(); };
      list.appendChild(item);
    });
    open();
  });
  input.addEventListener('blur', ()=> setTimeout(close,150));
}
bindAutocomplete('cliCidade','cliCidadeList');
bindAutocomplete('forCidade','forCidadeList');

/* ===== Limpar ===== */
document.getElementById('limpar').onclick=()=>{
  document.getElementById('rom').value='';
  document.getElementById('obs').value='';
  ['cliTel','cliNome','cliCidade','forTel','forNome','forCidade'].forEach(id=>document.getElementById(id).value='');
  itensDiv.innerHTML=''; itensDiv.appendChild(itemRow()); somaTotal();
  fileInput.value=''; fotosData=[]; renderThumbs();
  document.getElementById('msg').style.display='none';
  document.getElementById('data').value=todayISO();
};

/* ===== Enviar ===== */
document.getElementById('enviar').onclick=async ()=>{
  const rom=Number(document.getElementById('rom').value);
  const data=document.getElementById('data').value;
  const obs=document.getElementById('obs').value.trim();

  const cliTel=document.getElementById('cliTel').value.trim();
  const cliNome=document.getElementById('cliNome').value.trim();
  const cliCidade=document.getElementById('cliCidade').value.trim();

  const forTel=document.getElementById('forTel').value.trim();
  const forNome=document.getElementById('forNome').value.trim();
  const forCidade=document.getElementById('forCidade').value.trim();

  const itens=[];
  itensDiv.querySelectorAll('.grid').forEach(row=>{
    const [t,s,q]=row.querySelectorAll('select, input');
    const qtd=Number(q.value||0);
    if(qtd>0) itens.push({tipo:t.value,tamanho:s.value,qtd});
  });

  // valida√ß√µes
  const miss=[];
  if(!rom) miss.push('ROM');
  if(!data) miss.push('Data');
  if(!cliTel) miss.push('Cliente ‚Ä¢ Telefone');
  if(!cliNome) miss.push('Cliente ‚Ä¢ Nome');
  if(!cliCidade) miss.push('Cliente ‚Ä¢ Cidade/UF');
  if(!forTel) miss.push('Fornecedor ‚Ä¢ Telefone');
  if(!forNome) miss.push('Fornecedor ‚Ä¢ Nome');
  if(!forCidade) miss.push('Fornecedor ‚Ä¢ Cidade/UF');
  if(!itens.length) miss.push('Itens');

  if(miss.length){ showMsg('err','Campos obrigat√≥rios ausentes: '+miss.join(', ')); return; }

  try{
    const body={
      rom, data, obs,
      cliente:{ tel:cliTel, nome:cliNome, local:cliCidade },
      fornecedor:{ tel:forTel, nome:forNome, local:forCidade },
      itens,
      fotos:fotosData.map(d=>({data:d}))
    };
    const r=await post('/rom/create', body);
    if(r.error){ showMsg('err', r.error); return; }
    showMsg('ok', `Romaneio enviado! C√≥digo: ${r.cod||'-'}`);
    // if(r.pdfUrl) window.open(r.pdfUrl,'_blank');
  }catch(e){
    showMsg('err','Erro de rede: '+e);
  }
};
</script>
</body>
</html>
