<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Romaneio • Painel</title>
<style>
  :root{
    --bg:#0b1324; --panel:#0f1729; --muted:#9fb0db; --text:#eaf0ff;
    --line:#1e2a46; --brand:#3b82f6; --accent:#1f6feb; --danger:#ef4444;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1080px;margin:26px auto;padding:0 16px}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .btn{border:0;border-radius:10px;padding:10px 14px;background:#15223d;color:#cfe1ff;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .chip{padding:8px 10px;border-radius:10px;background:#132040}
  .title{font-size:28px;font-weight:800;margin:14px 0 6px}
  .subtitle{color:var(--muted);font-size:13px}
  .row{display:grid;gap:12px}
  .grid2{grid-template-columns:1fr 1fr}
  .grid3{grid-template-columns:1fr 1fr 1fr}
  @media(max-width:820px){ .grid2,.grid3{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .header{display:flex;align-items:center;justify-content:space-between}
  label{display:block;margin-bottom:6px;color:#c9d6ff;font-weight:600}
  input,select,textarea{
    width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:10px;
    background:#0c1731;color:#e7efff;outline:none
  }
  .line{height:1px;background:var(--line);margin:12px 0}
  .small{font-size:12px;color:#a8b8dd}
  .right{display:flex;gap:8px;align-items:center}
  .hidden{display:none}

  /* previews */
  .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .thumb{width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}

  /* Tabs */
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0c1731;color:#dfe8ff;cursor:pointer}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent}

  /* REPORT (lista) */
  .report{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin:12px 0;break-inside:avoid}
  .rep-head{background:#0e1a33;color:#fff;padding:10px 12px;font-weight:700;display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .rep-meta{display:flex;gap:14px;flex-wrap:wrap;font-size:12px;color:#cdd6f6}
  .rep-title{font-weight:800}
  .rep-table{width:100%;border-collapse:collapse;font-size:13px}
  .rep-table th,.rep-table td{border:1px solid var(--line);padding:6px 8px;text-align:left;background:#0f1729}
  .rep-table th{background:#122143;font-weight:700}
  .rep-total{background:#101a34;text-align:right;font-weight:800}
  .sum{margin-left:10px}

  /* overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);display:none;align-items:center;justify-content:center;z-index:30}
  .spinner{background:#0f1729;border:1px solid var(--line);color:#afc2ee;padding:14px 18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .dots:after{content:"…";animation:dots 1.6s infinite steps(4)}
  @keyframes dots {0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}}

  /* PRINT (A4) */
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .report{break-inside:avoid}
    @page{ size:A4; margin:12mm }
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="header no-print">
    <div>
      <div class="title">🚚 Romaneio</div>
      <div class="subtitle" id="connTxt">Conectado • --:--</div>
    </div>
    <div class="right">
      <button class="btn" id="btnTheme">🌙/🌞</button>
      <button class="btn" id="btnRefresh">⟳ Atualizar</button>
      <button class="btn btn-danger" id="btnLogout">Sair</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs no-print">
    <button class="tab active" id="tabForm">Enviar Romaneio</button>
    <button class="tab" id="tabList">Romaneios</button>
    <button class="tab" id="tabUsers">Usuários</button>
  </div>

  <!-- ====== FORM ====== -->
  <section id="sectionForm">
    <!-- Cliente & Fornecedor -->
    <div class="card">
      <h2>Cliente & Fornecedor</h2>
      <div class="row grid2">
        <div>
          <label>ROM</label>
          <input id="fRom" type="number" placeholder="Ex.: 21" />
        </div>
        <div>
          <label>Data</label>
          <input id="fData" type="date" />
        </div>
      </div>

      <div class="row grid2">
        <div>
          <label>Cliente • Telefone</label>
          <input id="cliTel" placeholder="(85) 9 9999-9999" />
        </div>
        <div>
          <label>Cliente • Nome</label>
          <input id="cliNome" placeholder="Nome do cliente" />
        </div>
      </div>
      <div class="row grid2">
        <div>
          <label>Cliente • Cidade/UF</label>
          <input id="cliCid" placeholder="Fortaleza / CE" />
        </div>
        <div>
          <label>Fornecedor • Telefone</label>
          <input id="forTel" placeholder="(85) 3333-3333" />
        </div>
      </div>
      <div class="row grid2">
        <div>
          <label>Fornecedor • Nome</label>
          <input id="forNome" placeholder="Nome do fornecedor" />
        </div>
        <div>
          <label>Fornecedor • Cidade/UF</label>
          <input id="forCid" placeholder="Maracanaú / CE" />
        </div>
      </div>
    </div>

    <!-- Itens -->
    <div class="card">
      <h2>Itens</h2>
      <div class="row grid3">
        <div>
          <label>Tipo</label>
          <select id="itTipo">
            <option>Caixa</option>
            <option>Saco</option>
            <option>Encomenda</option>
          </select>
        </div>
        <div>
          <label>Tamanho</label>
          <select id="itTam">
            <option>P</option><option>M</option><option>G</option>
          </select>
        </div>
        <div>
          <label>Qtd</label>
          <input id="itQtd" type="number" value="1" min="1" />
        </div>
      </div>
      <div class="right" style="margin-top:10px">
        <button class="btn" id="btnAddItem">+ Adicionar item</button>
        <span class="small" id="totalItens">Total: 1</span>
      </div>
    </div>

    <!-- Fotos -->
    <div class="card">
      <h2>Fotos</h2>
      <div class="small">Você pode selecionar várias imagens. Pré-visualização abaixo.</div>
      <input id="fotos" type="file" accept="image/*" multiple />
      <div class="preview" id="previews"></div>
      <div class="right" style="margin-top:10px">
        <button class="btn btn-primary" id="btnEnviar">Enviar</button>
        <button class="btn" id="btnLimpar">Limpar</button>
      </div>
    </div>
  </section>

  <!-- ====== LIST ====== -->
  <section id="sectionList" class="hidden">
    <div class="card">
      <div class="header">
        <h2>Romaneios</h2>
        <div class="right">
          <button class="btn" id="btnPDF">Exportar PDF</button>
        </div>
      </div>
      <div class="row grid2">
        <div>
          <label>ROM</label>
          <select id="fltRom"><option value="all">Todos</option></select>
        </div>
        <div>
          <label>Cidade do Cliente</label>
          <select id="fltCid"><option value="all">Todas</option></select>
        </div>
      </div>
      <div style="margin-top:10px" class="right">
        <button class="btn btn-primary" id="btnFiltrar">Filtrar</button>
        <div id="sumario" class="small sum"></div>
      </div>
    </div>
    <div id="relatorios"></div>
  </section>

  <!-- ====== USERS placeholder ====== -->
  <section id="sectionUsers" class="hidden">
    <div class="card">
      <h2>Usuários</h2>
      <div class="small">(em breve) – listagem e permissões por papel.</div>
    </div>
  </section>

</div>

<!-- overlay -->
<div class="overlay" id="overlay"><div class="spinner"><span id="ovTxt">Processando</span><span class="dots"></span></div></div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

/* ===== helpers ===== */
const qs = (s,el=document)=> el.querySelector(s);
function toast(msg,type){ console.log(type||"info", msg); alert(msg); }
function overlay(show, txt){
  const ov=qs("#overlay");
  if(show){ qs("#ovTxt").textContent = txt||"Processando"; ov.style.display="flex"; }
  else ov.style.display="none";
}
function maskPhone(v){
  v = String(v||"").replace(/\D/g,"");
  if(v.length===11){ return v.replace(/^(\d{2})(\d)(\d{4})(\d{4})$/,"($1) $2 $3-$4"); }
  if(v.length===10){ return v.replace(/^(\d{2})(\d{4})(\d{4})$/,"($1) $2-$3"); }
  return v;
}
function nowISO(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

/* ===== session mock (você já faz login na index e salva localStorage) ===== */
function getSession(){
  // espera: { token, usuario }
  try{ return JSON.parse(localStorage.getItem("rom_sess")||"{}"); }catch(_){ return {}; }
}

/* ===== API ===== */
async function apiPost(path, body={}){
  const r = await fetch(API_BASE+"?path="+encodeURIComponent(path), {
    method:"POST",
    headers:{ "Content-Type":"application/json;charset=utf-8" },
    body: JSON.stringify(body)
  });
  return await r.json();
}

/* ===== UI tabs ===== */
function showTab(name){
  for(const [id,sec] of [["Form","#sectionForm"],["List","#sectionList"],["Users","#sectionUsers"]]){
    qs(sec).classList.toggle("hidden", id!==name);
    qs("#tab"+id).classList.toggle("active", id===name);
  }
}

/* ===== form ===== */
let itens = [{tipo:"Caixa", tamanho:"P", qtd:1}];
let fotosData = []; // base64

function refreshItens(){
  qs("#totalItens").textContent = "Total: "+itens.reduce((s,i)=>s+Number(i.qtd||0),0);
}

qs("#btnAddItem").addEventListener("click", ()=>{
  const i = {
    tipo: qs("#itTipo").value,
    tamanho: qs("#itTam").value,
    qtd: Number(qs("#itQtd").value||1)
  };
  if(i.qtd>0) itens.push(i);
  refreshItens();
});

qs("#btnLimpar").addEventListener("click", ()=>{
  itens = [{tipo:"Caixa", tamanho:"P", qtd:1}];
  qs("#previews").innerHTML = ""; fotosData = [];
  refreshItens();
});

qs("#fotos").addEventListener("change", (ev)=>{
  const files = Array.from(ev.target.files||[]);
  const host = qs("#previews");
  host.innerHTML = ""; fotosData = [];
  files.forEach(f=>{
    const rd = new FileReader();
    rd.onload = (e)=>{
      const dataUrl = e.target.result;
      fotosData.push({ dataUrl });
      const img = new Image(); img.className="thumb"; img.src=dataUrl; host.appendChild(img);
    };
    rd.readAsDataURL(f);
  });
});

/* auto mask + (futuro) autofill */
["cliTel","forTel"].forEach(id=>{
  qs("#"+id).addEventListener("input", (e)=>{
    const raw = e.target.value.replace(/\D/g,"");
    e.target.value = maskPhone(raw);
  });
});

/* enviar */
qs("#btnEnviar").addEventListener("click", async ()=>{
  // validações simples
  const req = (id,msg)=>{ const v=qs("#"+id).value.trim(); if(!v){ toast(msg||"Preencha os campos", "err"); throw "stop"; } return v; };
  try{
    const rom = req("fRom","Informe o ROM");
    const data = qs("#fData").value || new Date().toISOString().slice(0,10);

    const cli_tel = req("cliTel","Informe telefone do cliente").replace(/\D/g,"");
    const cli_nome = req("cliNome","Informe nome do cliente");
    const cli_cid  = req("cliCid","Informe cidade/UF do cliente");

    const for_tel = req("forTel","Informe telefone do fornecedor").replace(/\D/g,"");
    const for_nome= req("forNome","Informe nome do fornecedor");
    const for_cid = req("forCid","Informe cidade/UF do fornecedor");

    if(!itens.length || itens.reduce((s,i)=>s+Number(i.qtd||0),0)<=0){ toast("Adicione pelo menos 1 item","err"); return; }

    overlay(true,"Enviando");
    const body = {
      token:getSession().token,
      rom, data,
      cliente:{ tel:cli_tel, nome:cli_nome, local:cli_cid },
      fornecedor:{ tel:for_tel, nome:for_nome, local:for_cid },
      itens, fotos: fotosData
    };
    const r = await apiPost("/rom/create", body);
    overlay(false);
    if(!r.ok){ toast(r.error||"Falha no envio","err"); return; }

    toast("Romaneio enviado! Código "+r.cod, "ok");
    if(r.whatsappUrl){
      if(confirm("Abrir WhatsApp do cliente com o comprovante?")) window.open(r.whatsappUrl,"_blank");
    }
    // limpar leve
    qs("#btnLimpar").click();
  }catch(e){ if(e!=="stop"){ overlay(false); console.error(e); } }
});

/* ===== Romaneios (filtros + render) ===== */
async function loadFilters(){
  try{
    const r = await apiPost("/rom/filters",{ token:getSession().token });
    const romSel = qs("#fltRom"), cidSel = qs("#fltCid");
    romSel.innerHTML = `<option value="all">Todos</option>` + (r.roms||[]).map(x=>`<option>${x}</option>`).join("");
    cidSel.innerHTML = `<option value="all">Todas</option>` + (r.cidades||[]).map(x=>`<option>${x}</option>`).join("");
  }catch{ toast("Falha ao carregar filtros","err"); }
}

async function loadRelatorio(){
  const body = { token:getSession().token, rom:qs("#fltRom").value, cidade:qs("#fltCid").value };
  overlay(true,"Buscando");
  try{
    const r = await apiPost("/rom/list", body);
    overlay(false);
    if(!r.ok){ toast(r.error||"Falha","err"); return; }
    qs("#sumario").textContent = `Clientes: ${r.clientes.length} • Volumes (total): ${r.totalGeral}`;
    const host = qs("#relatorios"); host.innerHTML="";

    r.clientes.forEach(c=> host.appendChild(makeClientReport(c)));
    // guardo último dataset para exportar pdf
    window.__lastReport = { filtroRom: body.rom, filtroCid: body.cidade, data: r };
  }catch(e){ overlay(false); toast("Erro ao listar", "err"); }
}

function makeClientReport(c){
  const wrap = document.createElement("div");
  wrap.className = "report";
  wrap.innerHTML = `
    <div class="rep-head">
      <div class="rep-title">JR TRANSPORTES</div>
      <div class="rep-meta">
        <div><b>ROMANEIO</b> ${c.rom||"-"}</div>
        <div><b>CLIENTE</b> ${esc(c.cliente.nome||"-")}</div>
        <div><b>CIDADE</b> ${esc(c.cliente.cidade_uf||"-")}</div>
        <div><b>CONTATO</b> ${maskPhone(c.cliente.tel||"")}</div>
      </div>
    </div>
    <table class="rep-table">
      <thead><tr>
        <th>FORNECEDOR</th>
        <th>CÓDIGO</th>
        <th>CADÁ</th>
        <th>BACO</th>
        <th>TAMANHO/ITEM</th>
        <th>DATA</th>
        <th>VALOR UNIT</th>
        <th>VALOR TOTAL</th>
        <th>OBSERVAÇÃO</th>
      </tr></thead>
      <tbody>
        ${c.linhas.map(l=>`
          <tr>
            <td>${esc(l.fornecedor||"")}</td>
            <td>${esc(l.codigo||"")}</td>
            <td>${Number(l.qtd||0)}</td>
            <td></td>
            <td>${esc(l.item||"")}</td>
            <td>${esc(l.data||"")}</td>
            <td>${esc(l.valorUnit||"")}</td>
            <td>${esc(l.valorTotal||"")}</td>
            <td>${esc(l.obs||"")}</td>
          </tr>
        `).join("")}
        <tr><td colspan="9" class="rep-total">VOLUMES (cliente): ${c.totalVol}</td></tr>
      </tbody>
    </table>`;
  return wrap;
}
function esc(s){ return String(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

/* Exportar PDF (A4, sem quebrar cliente) */
qs("#btnPDF").addEventListener("click", ()=>{
  const R = window.__lastReport;
  if(!R){ toast("Gere o relatório primeiro (Filtrar).","err"); return; }

  const w = window.open("", "_blank");
  const css = `
    <style>
      body{ font:12px/1.4 Arial, Helvetica, sans-serif; color:#111; margin:0 }
      .hdr{padding:12px 16px 0 16px}
      .muted{color:#555;font-size:12px}
      .report{ border:1px solid #ddd; border-radius:10px; margin:12px 16px; overflow:hidden; break-inside:avoid; }
      .rep-head{ background:#0e1a33; color:#fff; padding:8px 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; }
      .rep-title{ font-weight:800 }
      .rep-meta{ display:flex; gap:12px; flex-wrap:wrap; font-size:12px }
      table{ width:100%; border-collapse:collapse; font-size:12px }
      th,td{ border:1px solid #e5e5e5; padding:6px 8px; }
      th{ background:#f1f4fb; }
      .rep-total{ background:#f5f7ff; font-weight:700; text-align:right }
      @page{ size:A4; margin:12mm }
      .report{ break-inside:avoid }
    </style>`;

  const head = `
    <div class="hdr">
      <h2 style="margin:8px 16px">Relatório de Romaneios</h2>
      <div class="muted" style="margin:0 16px 10px 16px">
        ROM: <b>${R.filtroRom==="all"?"Todos":R.filtroRom}</b> •
        Cidade: <b>${R.filtroCid==="all"?"Todas":R.filtroCid}</b> •
        Gerado em: ${new Date().toLocaleString()}
      </div>
    </div>`;

  let body = head;
  R.data.clientes.forEach(c=>{
    body += `
    <div class="report">
      <div class="rep-head">
        <div class="rep-title">JR TRANSPORTES</div>
        <div class="rep-meta">
          <div><b>ROMANEIO</b> ${c.rom||"-"}</div>
          <div><b>CLIENTE</b> ${esc(c.cliente.nome||"-")}</div>
          <div><b>CIDADE</b> ${esc(c.cliente.cidade_uf||"-")}</div>
          <div><b>CONTATO</b> ${maskPhone(c.cliente.tel||"")}</div>
        </div>
      </div>
      <table>
        <thead><tr>
          <th>FORNECEDOR</th><th>CÓDIGO</th><th>CADÁ</th><th>BACO</th>
          <th>TAMANHO/ITEM</th><th>DATA</th><th>VALOR UNIT</th><th>VALOR TOTAL</th><th>OBS.</th>
        </tr></thead>
        <tbody>
          ${c.linhas.map(l=>`
            <tr>
              <td>${esc(l.fornecedor||"")}</td>
              <td>${esc(l.codigo||"")}</td>
              <td>${Number(l.qtd||0)}</td>
              <td></td>
              <td>${esc(l.item||"")}</td>
              <td>${esc(l.data||"")}</td>
              <td>${esc(l.valorUnit||"")}</td>
              <td>${esc(l.valorTotal||"")}</td>
              <td>${esc(l.obs||"")}</td>
            </tr>`).join("")}
          <tr><td colspan="9" class="rep-total">VOLUMES (cliente): ${c.totalVol}</td></tr>
        </tbody>
      </table>
    </div>`;
  });

  w.document.write(`<html><head><meta charset="utf-8">${css}</head><body>${body}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
});

qs("#btnFiltrar").addEventListener("click", loadRelatorio);

/* ===== init ===== */
function init(){
  // conexão
  qs("#connTxt").textContent = "Conectado • "+new Date().toLocaleString();
  qs("#fData").value = new Date().toISOString().slice(0,10);

  // topo
  qs("#btnRefresh").addEventListener("click", ()=>location.reload());
  qs("#btnTheme").addEventListener("click", ()=>document.body.classList.toggle("light"));
  qs("#btnLogout").addEventListener("click", ()=>{ localStorage.removeItem("rom_sess"); location.href="./index.html"; });

  // tabs
  qs("#tabForm").addEventListener("click", ()=>showTab("Form"));
  qs("#tabList").addEventListener("click", async ()=>{ showTab("List"); await loadFilters(); await loadRelatorio(); });
  qs("#tabUsers").addEventListener("click", ()=>showTab("Users"));

  refreshItens();
}
init();
</script>
</body>
</html>
