<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Romaneio ‚Ä¢ Painel</title>
<style>
:root{
  --bg:#0b1320; --card:#121b2e; --muted:#8793ab; --text:#eaf1ff; --line:rgba(255,255,255,.08);
  --primary:#4c8dff; --primary-600:#3a74d6; --danger:#ff6b6b; --ok:#19c37d;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0b1320;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit}
.nav{
  position:sticky; top:0; z-index:50; background:rgba(9,16,31,.7); backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line); padding:12px 16px; display:flex; align-items:center; gap:10px;
}
.brand{display:flex; align-items:center; gap:8px; font-weight:800}
.badge{padding:6px 10px; background:#0f1729; border:1px solid var(--line); border-radius:10px; font-size:12px}
.sp{flex:1}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#1a2340;color:#dfe8ff;cursor:pointer}
.btn:hover{filter:brightness(1.06)}
.btn-primary{background:var(--primary)}
.btn-danger{background:#ff5d5d}
.container{max-width:1120px;margin:16px auto;padding:0 16px}
.card{background:#121b2e;border:1px solid var(--line);border-radius:16px;padding:16px;margin:16px 0}
h2{margin:0 0 10px}
.grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.fld{display:flex;flex-direction:column;gap:6px}
input,select,textarea{
  background:#0f1729;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px
}
.small{font-size:12px;color:var(--muted)}
.item-row{display:grid;grid-template-columns:1.4fr 1fr .8fr 46px;gap:10px;align-items:center;margin-top:10px}
.thumb{width:90px;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{background:#0f1729;border:1px solid var(--line); padding:8px 10px;border-radius:999px;font-size:12px}
.progress{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
.box{background:#111a2d;border:1px solid var(--line);border-radius:16px;padding:18px;min-width:320px; text-align:center}
.bar{height:8px;background:#0f1729;border-radius:999px;overflow:hidden;margin-top:12px}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,#63a4ff,#4c8dff);transition:width .2s}
.ok{color:var(--ok)} .err{color:var(--danger)}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
</style>
</head>
<body>
  <div class="nav">
    <div class="brand">üöö <span>Romaneio</span></div>
    <span id="who" class="badge">‚Äî</span>
    <div class="sp"></div>
    <a class="btn" href="#" id="tabRom">Enviar Romaneio</a>
    <a class="btn" href="#" id="tabList">Romaneios</a>
    <a class="btn" href="#" id="tabCli">Clientes</a>
    <a class="btn" href="#" id="tabUsr">Usu√°rios</a>
    <button id="btnTheme" class="btn" title="Tema">üåô/üåû</button>
    <button id="btnReload" class="btn" title="Atualizar">‚ü≥ Atualizar</button>
    <button id="btnOut" class="btn btn-danger">Sair</button>
  </div>

  <div class="container" id="sectionRom">
    <div class="card">
      <div class="small" id="stamp"></div>
      <h2>Itens</h2>

      <!-- Itens -->
      <div id="items"></div>
      <div style="margin-top:8px">
        <button class="btn" id="btnAddItem">+ Adicionar item</button>
        <span class="chip">Total: <b id="totalQtd">0</b></span>
      </div>
    </div>

    <!-- Fotos -->
    <div class="card">
      <h2>Fotos</h2>
      <div class="small">Voc√™ pode selecionar m√∫ltiplas imagens. Pr√©-visualiza√ß√£o abaixo.</div>
      <input id="inFotos" type="file" accept="image/*" multiple style="margin-top:8px"/>
      <div id="previews" class="chips"></div>
      <div style="margin-top:12px; display:flex; gap:10px">
        <button id="btnSend" class="btn btn-primary">Enviar</button>
        <button id="btnClear" class="btn">Limpar</button>
      </div>
      <div id="status" class="small"></div>
    </div>

    <!-- Cliente / Fornecedor -->
    <div class="card">
      <h2>Cliente & Fornecedor</h2>
      <div class="grid2">
        <div class="fld"><label>ROM</label><input id="rom" type="number" placeholder="Ex.: 21"/></div>
        <div class="fld"><label>Data</label><input id="data" type="date"/></div>
      </div>
      <hr>
      <div class="grid2">
        <div class="fld"><label>Cliente ‚Ä¢ Telefone</label><input id="cli_tel" placeholder="(85) 9 9999-9999"/></div>
        <div class="fld"><label>Cliente ‚Ä¢ Nome</label><input id="cli_nome" placeholder="Nome do cliente"/></div>
      </div>
      <div class="fld"><label>Cliente ‚Ä¢ Cidade/UF</label><input id="cli_local" placeholder="Ex.: Fortaleza/CE"/></div>
      <hr>
      <div class="grid2">
        <div class="fld"><label>Fornecedor ‚Ä¢ Telefone</label><input id="for_tel" placeholder="(85) 9 9999-9999"/></div>
        <div class="fld"><label>Fornecedor ‚Ä¢ Nome</label><input id="for_nome" placeholder="Nome do fornecedor"/></div>
      </div>
      <div class="fld"><label>Fornecedor ‚Ä¢ Cidade/UF</label><input id="for_local" placeholder="Ex.: Maracana√∫/CE"/></div>
      <div class="fld"><label>Observa√ß√µes</label><textarea id="obs" rows="3" placeholder="Ex.: Doca 3, √†s 16h"></textarea></div>
    </div>
  </div>

  <!-- Se√ß√µes futuras (placeholder) -->
  <div class="container" id="sectionList" style="display:none">
    <div class="card"><h2>Romaneios</h2><div class="small">Lista/relat√≥rios entram aqui numa pr√≥xima etapa.</div></div>
  </div>
  <div class="container" id="sectionCli" style="display:none">
    <div class="card"><h2>Clientes</h2><div class="small">Cadastro b√°sico numa pr√≥xima etapa.</div></div>
  </div>
  <div class="container" id="sectionUsr" style="display:none">
    <div class="card"><h2>Usu√°rios</h2><div class="small">Gest√£o de usu√°rios/perfis numa pr√≥xima etapa.</div></div>
  </div>

  <!-- overlay progresso -->
  <div class="progress" id="overlay">
    <div class="box">
      <div id="overlayTxt">Enviando‚Ä¶</div>
      <div class="bar"><div id="overlayBar"></div></div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";

/* ====== UTILS ====== */
const qs = s=>document.querySelector(s);
const fmtDate = d => new Date(d||Date.now()).toISOString().slice(0,10);
const toast = (t,cls)=>{ const el=qs("#status"); el.className="small "+(cls||""); el.textContent=t; };
const overlay = (v, txt, p)=>{ const o=qs("#overlay"); o.style.display= v?"flex":"none"; qs("#overlayTxt").textContent = txt||""; if(typeof p==="number") qs("#overlayBar").style.width = (p*100)+"%"; };
const getSession = ()=>{ try{return JSON.parse(localStorage.getItem("rom_session")||"{}");}catch(_){return{}}; };

/* ====== THEME / RELOAD / TABS ====== */
qs("#btnTheme").onclick = ()=>{ const k="rom_theme"; localStorage.setItem(k,(localStorage.getItem(k)==="dark"?"light":"dark")); location.reload(); };
qs("#btnReload").onclick = ()=> location.href = "app.html?v="+Date.now();

const showTab = (id)=>{ ["Rom","List","Cli","Usr"].forEach(s=>qs("#section"+s).style.display = (s===id?"block":"none")); };
qs("#tabRom").onclick = (e)=>{e.preventDefault();showTab("Rom");};
qs("#tabList").onclick= (e)=>{e.preventDefault();showTab("List");};
qs("#tabCli").onclick = (e)=>{e.preventDefault();showTab("Cli");};
qs("#tabUsr").onclick = (e)=>{e.preventDefault();showTab("Usr");};

/* ====== API ====== */
async function apiPost(path, data){
  const r = await fetch(API_BASE + "?path=" + encodeURIComponent(path), {
    method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(data||{}), mode:"cors", credentials:"omit",
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

/* ====== SESSION header ====== */
(function(){
  const s = getSession();
  if(!s?.token){ location.href="index.html"; return; }
  qs("#who").textContent = `${s.usuario} ‚Ä¢ ${new Date().toLocaleString()}`;
  qs("#data").value = fmtDate();
  qs("#stamp").textContent = "Conectado ‚Ä¢ " + new Date().toLocaleString();
})();
qs("#btnOut").onclick = async ()=>{
  try{ await apiPost("/logout",{ token:getSession().token }); }catch(_){}
  localStorage.removeItem("rom_session"); location.href="index.html";
};

/* ====== ITENS ====== */
const itemsEl = qs("#items");
const totalQtdEl = qs("#totalQtd");
const tipos = ["Caixa","Pacote","Fardo","Volume","Saco","Palete"];
const tamanhos = ["P","M","G","GG"];
let items = [];

function renderItems(){
  itemsEl.innerHTML = "";
  let total = 0;
  items.forEach((it,idx)=>{
    total += Number(it.qtd||0);
    const row = document.createElement("div");
    row.className="item-row";
    row.innerHTML = `
      <select class="it-tipo">
        ${tipos.map(t=>`<option ${it.tipo===t?"selected":""}>${t}</option>`).join("")}
      </select>
      <select class="it-tamanho">
        ${tamanhos.map(t=>`<option ${it.tamanho===t?"selected":""}>${t}</option>`).join("")}
      </select>
      <input class="it-qtd" type="number" min="1" value="${it.qtd||1}">
      <button class="btn btn-danger it-x">‚úï</button>`;
    row.querySelector(".it-tipo").onchange = e=>{items[idx].tipo=e.target.value;};
    row.querySelector(".it-tamanho").onchange = e=>{items[idx].tamanho=e.target.value;};
    row.querySelector(".it-qtd").oninput = e=>{items[idx].qtd=Number(e.target.value||0); updateTotal();};
    row.querySelector(".it-x").onclick = ()=>{ items.splice(idx,1); renderItems(); };
    itemsEl.appendChild(row);
  });
  totalQtdEl.textContent = total;
}
function updateTotal(){ totalQtdEl.textContent = items.reduce((s,i)=>s+Number(i.qtd||0),0); }

qs("#btnAddItem").onclick = ()=>{ items.push({tipo:"Caixa", tamanho:"P", qtd:1}); renderItems(); };
/* come√ßa com 1 item */
items = [{tipo:"Caixa", tamanho:"P", qtd:1}];
renderItems();

/* ====== FOTOS & PREVIEW ====== */
let fotosFiles = [];
qs("#inFotos").addEventListener("change", (ev)=>{
  fotosFiles = Array.from(ev.target.files||[]);
  const p = qs("#previews"); p.innerHTML="";
  fotosFiles.forEach(f=>{
    const img = document.createElement("img");
    img.className="thumb";
    img.src = URL.createObjectURL(f);
    p.appendChild(img);
  });
});

/* ====== ENVIAR ====== */
qs("#btnSend").onclick = async ()=>{
  const sess = getSession(); if(!sess?.token){ location.href="index.html"; return; }

  // valida√ß√µes b√°sicas
  const rom = Number(qs("#rom").value||0);
  if(!rom){ toast("Informe o ROM","err"); return; }
  if(items.reduce((s,i)=>s+Number(i.qtd||0),0)<=0){ toast("Nenhum item informado","err"); return; }

  // monta corpo
  const body = {
    token:sess.token,
    rom,
    data: qs("#data").value || fmtDate(),
    obs:  qs("#obs").value || "",
    cliente:{
      tel:  qs("#cli_tel").value,  nome: qs("#cli_nome").value,
      local:qs("#cli_local").value
    },
    fornecedor:{
      tel:  qs("#for_tel").value,  nome: qs("#for_nome").value,
      local:qs("#for_local").value
    },
    itens: items.map(i=>({tipo:i.tipo, tamanho:i.tamanho, qtd:Number(i.qtd||0)}))
  };

  // converte fotos em base64 dataURL (sem abrir Google)
  overlay(true,"Preparando imagens‚Ä¶",.05);
  const fotos = [];
  for(let i=0;i<fotosFiles.length;i++){
    const f = fotosFiles[i];
    const dataUrl = await fileToDataURL(f);
    fotos.push({name:f.name, dataUrl});
    overlay(true,`Convertendo ${i+1}/${fotosFiles.length}‚Ä¶`, (i+1)/fotosFiles.length*.5 + .05);
  }
  body.fotos = fotos;

  try{
    overlay(true,"Enviando‚Ä¶",.65);
    const r = await apiPost("/rom/create", body);
    overlay(true,"Finalizando‚Ä¶",.95);
    if(r.error){ overlay(false); toast(r.error,"err"); return; }
    overlay(false);
    toast(`OK! C√≥digo ${r.cod}. PDF gerado.`, "ok");
    // limpa somente fotos
    qs("#inFotos").value=""; fotosFiles=[]; qs("#previews").innerHTML="";
  }catch(e){
    overlay(false); toast("Erro ao enviar: "+e.message,"err");
  }
};

qs("#btnClear").onclick = ()=>{
  items = [{tipo:"Caixa", tamanho:"P", qtd:1}]; renderItems();
  qs("#inFotos").value=""; fotosFiles=[]; qs("#previews").innerHTML="";
  ["cli_tel","cli_nome","cli_local","for_tel","for_nome","for_local","obs","rom"].forEach(id=>qs("#"+id).value="");
  qs("#data").value = fmtDate();
  toast("");
};

/* helpers */
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onerror = () => rej(new Error("Falha ao ler imagem"));
    fr.onload  = () => res(fr.result);
    fr.readAsDataURL(file);
  });
}
</script>
</body>
</html>
