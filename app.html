<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Romaneio ‚Ä¢ Painel</title>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  :root{
    --bg:#0b1220; --card:#0e1728; --text:#e5e9f0; --muted:#9aa3b2; --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --input:#0f172a; --ring:#3b82f6;
  }
  .light{
    --bg:#f6f7fb; --card:#ffffff; --text:#0b1220; --muted:#5c6470; --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --input:#f1f5f9; --ring:#3b82f6;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:var(--card);z-index:10;box-shadow:0 2px 14px rgba(0,0,0,.25)}
  .wrap{max-width:1080px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
  .brand{font-weight:700}
  nav{margin-left:auto;display:flex;gap:8px}
  .btn{padding:10px 12px;border-radius:10px;border:0;background:#334155;color:#fff;cursor:pointer}
  .btn.primary{background:var(--primary)}
  .btn.danger{background:var(--danger)}
  .btn.ok{background:var(--ok)}
  main{max-width:1080px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:16px}
  label{font-size:14px;color:var(--muted)}
  select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:var(--input);color:var(--text);outline:none}
  select:focus,input:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  @media (max-width:900px){ .col-3,.col-4,.col-6{grid-column:span 12} }
  .thumbs{display:flex;gap:10px;flex-wrap:wrap}
  .thumb{width:120px;height:120px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
  .muted{color:var(--muted);font-size:13px}
  /* progress */
  #progress{position:fixed;left:0;top:0;height:3px;width:0;background:var(--primary);z-index:9999;transition:width .25s}
</style>
</head>
<body>
<div id="progress"></div>

<header>
  <div class="wrap">
    <div class="brand">üöö Romaneio</div>
    <nav>
      <button id="btn-theme" class="btn">üåô/‚òÄÔ∏è</button>
      <button id="btn-hard" class="btn">‚Üª Atualizar</button>
      <button id="btn-logout" class="btn danger">Sair</button>
    </nav>
  </div>
</header>

<main>
  <div class="card">
    <h3 style="margin:0 0 8px">Enviar Romaneio</h3>
    <div class="grid">
      <div class="col-3">
        <label>ROM</label>
        <input id="rom" placeholder="Ex.: 21">
      </div>
      <div class="col-3">
        <label>Data</label>
        <input id="data" type="date">
      </div>
      <div class="col-6">
        <label>Observa√ß√µes</label>
        <input id="obs" placeholder="Ex.: Doca 3, at√© 16h">
      </div>

      <div class="col-6">
        <label>Telefone do Cliente</label>
        <input id="cli_tel" placeholder="85999999999">
      </div>
      <div class="col-3">
        <label>Nome do Cliente</label>
        <input id="cli_nome" placeholder="Nome do cliente">
      </div>
      <div class="col-3">
        <label>Cidade/UF</label>
        <input id="cli_local" placeholder="Fortaleza/CE">
      </div>

      <div class="col-6">
        <label>Telefone do Fornecedor</label>
        <input id="for_tel" placeholder="85999999999">
      </div>
      <div class="col-3">
        <label>Nome do Fornecedor</label>
        <input id="for_nome" placeholder="Nome do fornecedor">
      </div>
      <div class="col-3">
        <label>Cidade/UF</label>
        <input id="for_local" placeholder="Maracana√∫/CE">
      </div>

      <div class="col-12"><hr style="border-color:rgba(255,255,255,.1)"></div>

      <div class="col-4">
        <label>Tipo</label>
        <select id="item_tipo">
          <option>Caixa</option>
          <option>Saco</option>
          <option>Palete</option>
          <option>Outro</option>
        </select>
      </div>
      <div class="col-4">
        <label>Tamanho</label>
        <select id="item_tam">
          <option>P</option><option>M</option><option>G</option><option>Outro</option>
        </select>
      </div>
      <div class="col-3">
        <label>Qtd</label>
        <input id="item_qtd" type="number" min="1" value="1">
      </div>
      <div class="col-1" style="display:flex;align-items:flex-end">
        <button id="btn-add-item" class="btn">+ Item</button>
      </div>

      <div class="col-12">
        <div id="items" class="muted">Nenhum item adicionado.</div>
      </div>

      <div class="col-12">
        <label>Fotos</label>
        <input id="fotos" type="file" accept="image/*" multiple>
        <div class="muted">Voc√™ pode selecionar v√°rias imagens. Pr√©-visualiza√ß√£o abaixo.</div>
        <div id="thumbs" class="thumbs" style="margin-top:8px"></div>
      </div>

      <div class="col-12" style="display:flex;gap:10px;margin-top:12px">
        <button id="btn-send" class="btn primary">Enviar</button>
        <button id="btn-clear" class="btn">Limpar</button>
      </div>

      <div class="col-12">
        <div id="msg" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Roman√©ios</h3>
    <div class="muted">Lista/relat√≥rios entram aqui numa pr√≥xima etapa.</div>
  </div>
</main>

<script>
/* ======= CONFIG ======= */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec"; // <- sua URL /exec

/* ======= THEME ======= */
function applyTheme(){
  const t = localStorage.getItem("theme") || "dark";
  if(t==="light") document.documentElement.classList.add("light");
  else document.documentElement.classList.remove("light");
}
applyTheme();
document.getElementById("btn-theme").onclick = ()=>{
  const cur = localStorage.getItem("theme") || "dark";
  const nx = cur==="dark"?"light":"dark";
  localStorage.setItem("theme", nx);
  applyTheme();
};

/* ======= HARD REFRESH ======= */
document.getElementById("btn-hard").onclick = ()=>{
  const q = new URLSearchParams(location.search);
  q.set("v", Date.now());
  location.href = location.pathname + "?" + q.toString() + (location.hash||"");
};

/* ======= PROGRESS ======= */
const progress = {
  el: document.getElementById("progress"),
  start(){ this.el.style.width="10%"; requestAnimationFrame(()=> this.el.style.width="70%"); },
  end(){ this.el.style.width="100%"; setTimeout(()=> this.el.style.width="0", 250); }
};

/* ======= SESSION ======= */
let SESSION=null;
try{ SESSION=JSON.parse(localStorage.getItem("session")||"null"); }catch(_){}
if(!SESSION || !SESSION.token){ location.href="index.html?v="+Date.now(); }

/* ======= helpers ======= */
const $ = s => document.querySelector(s);
const msg = $("#msg");
function setMsg(t, ok=false){
  msg.textContent = t||"";
  msg.style.color = ok? "var(--ok)" : "var(--muted)";
}

/* ======= default date ======= */
(function(){
  const d = new Date();
  const y=d.getFullYear(), m=("0"+(d.getMonth()+1)).slice(-2), dd=("0"+d.getDate()).slice(-2);
  $("#data").value = `${y}-${m}-${dd}`;
})();

/* ======= items ======= */
const items = [];
function renderItems(){
  if(!items.length){ $("#items").textContent="Nenhum item adicionado."; return; }
  $("#items").innerHTML = items.map((i,idx)=>`‚Ä¢ ${i.tipo} ${i.tamanho} ‚Äî ${i.qtd} <a href="#" data-i="${idx}" class="rm">[remover]</a>`).join("<br>");
  $("#items").querySelectorAll(".rm").forEach(a=> a.onclick=(e)=>{ e.preventDefault(); items.splice(a.dataset.i,1); renderItems(); });
}
$("#btn-add-item").onclick = ()=>{
  const tipo = $("#item_tipo").value, tamanho=$("#item_tam").value, qtd= Number($("#item_qtd").value||0);
  if(qtd<=0) return;
  items.push({tipo,tamanho,qtd});
  renderItems();
};

/* ======= fotos preview ======= */
const fotosSel = []; // {name, dataUrl}
$("#fotos").addEventListener("change", async (ev)=>{
  fotosSel.length = 0;
  $("#thumbs").innerHTML="";
  const files = Array.from(ev.target.files||[]);
  for(const f of files){
    const dataUrl = await fileToDataUrl(f);
    fotosSel.push({name:f.name, dataUrl});
    const img = new Image(); img.src=dataUrl; img.className="thumb";
    $("#thumbs").appendChild(img);
  }
});
function fileToDataUrl(file){
  return new Promise(res=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.readAsDataURL(file); });
}

/* ======= API ======= */
async function post(path, body){
  progress.start();
  try{
    const r = await fetch(API_BASE+"?path="+encodeURIComponent(path), {
      method:"POST",
      headers:{"Content-Type":"application/json;charset=utf-8"},
      body: JSON.stringify(Object.assign({}, body||{}, {token:SESSION.token}))
    });
    return await r.json();
  }finally{ progress.end(); }
}

/* ======= send ======= */
$("#btn-send").onclick = async ()=>{
  setMsg("");
  const rom = $("#rom").value.trim();
  const data = $("#data").value;
  const obs  = $("#obs").value.trim();
  const cliente = { tel:$("#cli_tel").value.trim(), nome:$("#cli_nome").value.trim(), local:$("#cli_local").value.trim() };
  const fornecedor = { tel:$("#for_tel").value.trim(), nome:$("#for_nome").value.trim(), local:$("#for_local").value.trim() };

  if(!rom || !cliente.tel || !cliente.nome || !cliente.local || !fornecedor.tel || !fornecedor.nome || !fornecedor.local){
    setMsg("Preencha os campos obrigat√≥rios (ROM, cliente e fornecedor)."); return;
  }
  if(!items.length){ setMsg("Adicione pelo menos um item."); return; }

  const fotos = fotosSel.map(f=>({ name:f.name, data:f.dataUrl })); // base64 inline
  const payload = { rom, data, obs, cliente, fornecedor, itens:items, fotos };
  const j = await post("/rom/create", payload);

  if(j && j.ok){
    setMsg(`Enviado! C√≥digo: ${j.cod}  ‚Ä¢  PDF: ${j.pdfUrl}`, true);
    if(confirm("Abrir PDF do romaneio?")) window.open(j.pdfUrl, "_blank");
    if(confirm("Compartilhar no WhatsApp?")) window.open(j.whatsappUrl, "_blank");
    clearForm();
  }else{
    setMsg(j && j.error ? j.error : "Falha no envio");
  }
};

function clearForm(){
  $("#rom").value=""; $("#obs").value="";
  ["cli_tel","cli_nome","cli_local","for_tel","for_nome","for_local"].forEach(id=> $("#"+id).value="");
  items.length=0; renderItems();
  fotosSel.length=0; $("#thumbs").innerHTML=""; $("#fotos").value="";
}
$("#btn-clear").onclick = clearForm;

/* ======= logout ======= */
$("#btn-logout").onclick = async ()=>{
  try{ await post("/logout", {}); }catch(_){}
  localStorage.removeItem("session");
  location.href = "index.html?v="+Date.now();
};
</script>
</body>
</html>
