<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta name="color-scheme" content="dark light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const themeSaved = localStorage.getItem("theme") || "dark";
    if (themeSaved === "dark") document.documentElement.classList.add("dark");
  </script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen">
  <!-- Navbar -->
  <header class="sticky top-0 z-50 bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üöö</span>
        <div class="text-lg font-semibold">Romaneio</div>
        <span id="userBadge" class="ml-3 text-xs px-2 py-1 rounded-lg border border-slate-300 dark:border-slate-700 opacity-80"></span>
      </div>
      <nav class="hidden md:flex items-center gap-2">
        <a href="#rom" class="px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">Enviar Romaneio</a>
        <a href="#roms" class="px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">Romaneios</a>
        <a href="#clientes" class="px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">Clientes</a>
        <a href="#users" class="px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800">Usu√°rios</a>
        <button id="btnTheme" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700">üåô</button>
        <button id="btnSair" class="px-3 py-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white">Sair</button>
      </nav>
      <button class="md:hidden rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2" id="btnMenu">‚ò∞</button>
    </div>
  </header>

  <!-- Conte√∫do -->
  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <!-- Avisos -->
    <div id="alert" class="hidden rounded-xl p-3 border"></div>

    <!-- Se√ß√£o: Enviar Romaneio (resumo, campos principais) -->
    <section id="rom" class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4">
      <h2 class="text-xl font-semibold mb-4">Enviar Romaneio</h2>

      <form id="frmRom" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">ROM</label>
          <input id="romNum" type="number" min="1" required
                 class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
        </div>

        <div>
          <label class="block text-sm mb-1">Data</label>
          <input id="data" type="date" required
                 class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Observa√ß√µes</label>
          <textarea id="obs" rows="2"
                 class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2"></textarea>
        </div>

        <!-- Cliente -->
        <div class="md:col-span-2 grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-1">Telefone (cliente)</label>
            <input id="cliTel" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" placeholder="85999999999">
          </div>
          <div>
            <label class="block text-sm mb-1">Nome do cliente</label>
            <input id="cliNome" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
          </div>
          <div>
            <label class="block text-sm mb-1">Cidade/UF</label>
            <input id="cliLocal" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" placeholder="Fortaleza/CE">
          </div>
        </div>

        <!-- Fornecedor -->
        <div class="md:col-span-2 grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-1">Telefone (fornecedor)</label>
            <input id="forTel" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" placeholder="85999999999">
          </div>
          <div>
            <label class="block text-sm mb-1">Nome do fornecedor</label>
            <input id="forNome" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
          </div>
          <div>
            <label class="block text-sm mb-1">Cidade/UF</label>
            <input id="forLocal" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2" placeholder="Maracana√∫/CE">
          </div>
        </div>

        <!-- Itens (simples ‚Äì 1 linha por item) -->
        <div class="md:col-span-2">
          <label class="block text-sm mb-2">Itens</label>
          <div id="itens" class="space-y-2"></div>
          <button type="button" id="btnAddItem"
            class="mt-2 rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800">
            + Adicionar item
          </button>
        </div>

        <!-- Fotos (v√°rias) -->
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Fotos</label>
          <input id="fotos" type="file" accept="image/*" multiple
                 class="block w-full text-sm file:mr-3 file:rounded-xl file:border-0 file:bg-slate-200 dark:file:bg-slate-800 file:px-3 file:py-2 file:text-slate-900 dark:file:text-slate-100">
          <p class="text-xs opacity-70 mt-1">Voc√™ pode selecionar v√°rias imagens. Pr√©-visualiza√ß√£o ap√≥s selecionar.</p>
          <div id="preview" class="mt-3 grid grid-cols-3 md:grid-cols-6 gap-2"></div>
        </div>

        <div class="md:col-span-2 flex gap-2">
          <button class="rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2" type="submit">Enviar</button>
          <button class="rounded-xl border border-slate-300 dark:border-slate-700 px-4 py-2" type="reset">Limpar</button>
        </div>
      </form>
    </section>

    <!-- Outras se√ß√µes (placeholders s√≥ pra navega√ß√£o) -->
    <section id="roms" class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4">
      <h2 class="text-xl font-semibold mb-2">Romaneios</h2>
      <p class="opacity-70 text-sm">Lista/relat√≥rios entram aqui numa pr√≥xima etapa.</p>
    </section>

    <section id="clientes" class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4">
      <h2 class="text-xl font-semibold mb-2">Clientes</h2>
      <p class="opacity-70 text-sm">Cadastro/edi√ß√£o de clientes entra aqui (pr√≥xima etapa).</p>
    </section>

    <section id="users" class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-4">
      <h2 class="text-xl font-semibold mb-2">Usu√°rios</h2>
      <p class="opacity-70 text-sm">Lista/cadastro de usu√°rios (pr√≥xima etapa). Permiss√µes ser√£o respeitadas via <code>/whoami</code> + <code>perms</code>.</p>
    </section>
  </main>

  <script>
    // ==================== CONFIG ====================
    const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";
    // =================================================
    const $ = (sel) => document.querySelector(sel);

    // UI helpers
    function alertError(text){
      const a = $("#alert");
      a.className = "rounded-xl p-3 border border-rose-600/30 bg-rose-600/10 text-rose-700 dark:text-rose-300";
      a.textContent = text;
      a.classList.remove("hidden");
    }
    function alertOk(text){
      const a = $("#alert");
      a.className = "rounded-xl p-3 border border-emerald-600/30 bg-emerald-600/10 text-emerald-700 dark:text-emerald-300";
      a.textContent = text;
      a.classList.remove("hidden");
    }
    function alertHide(){ $("#alert").classList.add("hidden"); }

    // Tema
    $("#btnTheme").addEventListener("click", ()=>{
      const to = document.documentElement.classList.contains("dark") ? "light" : "dark";
      localStorage.setItem("theme", to);
      document.documentElement.classList.toggle("dark", to==="dark");
      $("#btnTheme").textContent = to==="dark" ? "üåô" : "‚òÄÔ∏è";
    });

    // Sess√£o
    const sess = (function(){
      try{ return JSON.parse(localStorage.getItem("rom.session")||"null"); }catch(_){ return null; }
    })();

    if(!sess || !sess.token){
      location.replace("./index.html");
    }else{
      $("#userBadge").textContent = `${sess.usuario} ‚Ä¢ ${sess.role || "-"}`;
      $("#btnTheme").textContent = (localStorage.getItem("theme")||"dark")==="dark" ? "üåô" : "‚òÄÔ∏è";
    }

    // Sair
    $("#btnSair").addEventListener("click", async ()=>{
      try{
        await fetch(API_BASE+"?path=/logout", {
          method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({token: sess.token}), mode:"cors"
        });
      }catch(_){}
      localStorage.removeItem("rom.session");
      location.replace("./index.html");
    });

    // Carrega data de hoje
    (function setHoje(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2, "0");
      const iso = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      $("#data").value = iso;
    })();

    // Itens din√¢micos (m√≠nimo vi√°vel)
    const itensBox = $("#itens");
    function makeItemRow(){
      const row = document.createElement("div");
      row.className = "grid grid-cols-12 gap-2";
      row.innerHTML = `
        <select class="col-span-5 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
          <option value="caixa">Caixa</option>
          <option value="saco">Saco</option>
          <option value="fardo">Fardo</option>
          <option value="palete">Palete</option>
        </select>
        <select class="col-span-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
          <option value="P">P</option>
          <option value="M">M</option>
          <option value="G">G</option>
        </select>
        <input type="number" min="1" value="1" class="col-span-3 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2">
        <button type="button" class="col-span-1 rounded-xl bg-rose-600 hover:bg-rose-700 text-white">‚úï</button>
      `;
      const btnX = row.querySelector("button");
      btnX.addEventListener("click", ()=> row.remove());
      return row;
    }
    $("#btnAddItem").addEventListener("click", ()=> itensBox.appendChild(makeItemRow()));
    // um item inicial
    itensBox.appendChild(makeItemRow());

    // Pr√©-visualiza√ß√£o das fotos
    const preview = $("#preview");
    $("#fotos").addEventListener("change", (ev)=>{
      preview.innerHTML = "";
      for(const file of ev.target.files){
        const url = URL.createObjectURL(file);
        const img = document.createElement("img");
        img.src = url;
        img.className = "w-full h-24 object-cover rounded-lg border border-slate-200 dark:border-slate-800";
        preview.appendChild(img);
      }
    });

    // Envio do romaneio (m√≠nimo vi√°vel com as regras do backend)
    $("#frmRom").addEventListener("submit", async (ev)=>{
      ev.preventDefault(); alertHide();

      const rom     = Number($("#romNum").value);
      const data    = $("#data").value; // yyyy-mm-dd
      const obs     = $("#obs").value.trim();

      const cliente = {
        tel:  $("#cliTel").value.trim(),
        nome: $("#cliNome").value.trim(),
        local:$("#cliLocal").value.trim(),
      };
      const fornecedor = {
        tel:  $("#forTel").value.trim(),
        nome: $("#forNome").value.trim(),
        local:$("#forLocal").value.trim(),
      };

      // itens
      const itens = [];
      itensBox.querySelectorAll(":scope > div").forEach(div=>{
        const [tipoEl, tamEl, qtdEl] = div.querySelectorAll("select, input");
        itens.push({ tipo:tipoEl.value, tamanho:tamEl.value, qtd:Number(qtdEl.value||0) });
      });

      // fotos => base64 dataURL
      const files = $("#fotos").files;
      const fotos = [];
      for (const f of files){
        const b64 = await fileToDataURL(f);
        fotos.push({ data: b64 });
      }

      const payload = { token: sess.token, rom, data, obs, cliente, fornecedor, itens, fotos };

      try{
        const r = await fetch(API_BASE+"?path=/rom/create", {
          method:"POST",
          headers: { "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
          mode:"cors",
        });
        const j = await r.json();
        if(j.error){ alertError(j.error); return; }
        // sucesso
        alertOk(`Romaneio enviado! C√≥digo: ${j.cod}`);
        // opcional: abrir PDF em nova guia
        if(j.pdfUrl) window.open(j.pdfUrl, "_blank");
      }catch(e){
        alertError("Falha ao enviar: "+e);
      }
    });

    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = ()=> res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
