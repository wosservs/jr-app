<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio â€¢ Login</title>
  <style>
    :root{
      --bg:#0b1320; --card:#121b2e; --muted:#7b8aa1; --text:#eaf1ff;
      --primary:#4c8dff; --primary-600:#3a74d6; --success:#19c37d; --danger:#ff6b6b;
      --shadow:0 18px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%} body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b1320 0%, #0d1528 100%); color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%; max-width:560px}
    .row-top{display:flex; gap:10px; justify-content:flex-end; margin-bottom:14px}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 14px;
      background:#1a2340; color:#dfe8ff; cursor:pointer; box-shadow:var(--shadow);
      display:inline-flex; align-items:center; gap:8px; font-weight:600
    }
    .btn:hover{filter:brightness(1.06)}
    .btn-primary{background:var(--primary)}
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:18px; padding:26px; box-shadow:var(--shadow);
    }
    h1{margin:0 0 10px; font-size:28px; display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted); font-size:14px}
    .fld{display:flex; flex-direction:column; gap:6px; margin-top:14px}
    .fld input{
      background:#0f1729; color:var(--text); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px 14px; font-size:16px; outline:none
    }
    .row{display:flex; gap:10px; margin-top:16px}
    .row .btn{flex:1}
    .ok{color:var(--success)} .err{color:var(--danger)}
    .ver{margin-top:8px; color:#8aa4ff; font-size:12px}
    /* progress */
    .progress{height:4px; width:100%; background:#0f1729; border-radius:999px; overflow:hidden; margin:14px 0 4px}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,#63a4ff,#4c8dff); transition:width .2s}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row-top">
      <button id="btnTheme" class="btn" title="Tema">ðŸŒ™/ðŸŒž</button>
      <button id="btnReload" class="btn" title="ForÃ§ar atualizaÃ§Ã£o">âŸ³ Atualizar</button>
    </div>

    <div class="card">
      <h1>ðŸšš Romaneio</h1>
      <div id="conn" class="muted">â€¦</div>

      <div class="fld">
        <label>UsuÃ¡rio</label>
        <input id="user" placeholder="admin" autocomplete="username"/>
      </div>
      <div class="fld">
        <label>Senha</label>
        <input id="pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>

      <div class="row">
        <button id="btnLogin" class="btn btn-primary">Entrar</button>
        <button id="btnPing" class="btn">Testar conexÃ£o</button>
      </div>

      <div class="progress" style="display:none" id="prog"><div class="bar" id="bar"></div></div>
      <div id="msg" class="muted" style="min-height:22px;margin-top:6px"></div>

      <div class="ver">v1.1.0</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
// URL da API atualizada com o seu link
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";


/* ====== UI helpers ====== */
const qs = s=>document.querySelector(s);
const msg = (t, cls="muted") => { qs("#msg").className=cls; qs("#msg").textContent=t||""; };
const setConn = (ok, txt) => qs("#conn").innerHTML = ok ? `Conectado â€¢ <span class="ok">${txt}</span>` : `<span class="err">${txt}</span>`;
const prog = (v)=>{ qs("#prog").style.display="block"; qs("#bar").style.width = (v*100).toFixed(0)+"%"; if(v>=1) setTimeout(()=>qs("#prog").style.display="none",350); };

/* ====== THEME ====== */
(function(){
  const key="rom_theme";
  const apply=()=>{ document.documentElement.dataset.theme=localStorage.getItem(key)||"dark"; };
  apply();
  qs("#btnTheme").onclick=()=>{ localStorage.setItem(key, (localStorage.getItem(key)==="dark"?"light":"dark")); apply(); };
})();

/* ====== RELOAD ====== */
qs("#btnReload").onclick=()=>{ location.href = location.pathname + "?v=" + Date.now(); };

/* ====== API ====== */
// FunÃ§Ã£o de API corrigida para evitar o erro 405
function apiPost(path, data) {
    return new Promise((resolve, reject) => {
        if(API_BASE.includes("COLE_A_URL")){
            return reject(new Error("Configure a URL da API na constante API_BASE."));
        }
        const xhr = new XMLHttpRequest();
        const url = API_BASE + "?path=" + encodeURIComponent(path);
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 400) {
                try {
                    resolve(JSON.parse(xhr.responseText));
                } catch(e) {
                    reject(new Error("Erro ao processar resposta do servidor."));
                }
            } else {
                reject(new Error("HTTP " + xhr.status));
            }
        };
        xhr.onerror = () => reject(new Error("Erro de conexÃ£o."));
        xhr.send(JSON.stringify(data || {}));
    });
}


/* ====== PING ON LOAD ====== */
(async()=>{
  try{
    const r = await apiPost("/ping", {});
    setConn(true, new Date().toLocaleString());
  }catch(e){
    setConn(false,"Falha ao conectar: " + e.message);
  }
})();

/* ====== AÃ§Ãµes ====== */
qs("#btnPing").onclick = async ()=>{
  try{ prog(.2); const r=await apiPost("/ping",{}); prog(1); msg("ConexÃ£o OK âœ“","ok"); }
  catch(e){ prog(1); msg(e.message,"err"); }
};

qs("#btnLogin").onclick = async ()=>{
  const usuario = qs("#user").value.trim() || "admin";
  const senha   = qs("#pass").value.trim();
  if(!senha){ msg("Informe a senha","err"); return; }
  try{
    prog(.2);
    const r = await apiPost("/login",{usuario,senha});
    prog(.6);
    if(r.error){ prog(1); msg(r.error,"err"); return; }
    
    localStorage.setItem("rom_session", JSON.stringify(r.session));
    prog(1);
    msg("Login OK. Redirecionandoâ€¦","ok");
    
    // CORREÃ‡ÃƒO: ConstrÃ³i uma URL absoluta para evitar o erro de 'Location'.
    const currentUrl = window.location.href;
    const directoryPath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
    const nextUrl = directoryPath + 'app.html?v=' + Date.now();
    location.href = nextUrl;
    
  }catch(e){
    prog(1); msg("Erro: "+e.message,"err");
  }
};
</script>
</body>
</html>

