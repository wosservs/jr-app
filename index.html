<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Romaneio ‚Ä¢ Login</title>
  <meta name="color-scheme" content="dark light" />
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tema salvo
    const themeSaved = localStorage.getItem("theme") || "dark";
    if (themeSaved === "dark") document.documentElement.classList.add("dark");
  </script>
  <style>
    /* Suaviza rolagem e evita zoom feio em iOS */
    html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Card -->
    <div class="rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 backdrop-blur p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <span class="text-3xl">üöö</span>
          <h1 class="text-2xl font-semibold">Romaneio</h1>
        </div>
        <button id="btnTheme" class="inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span id="icoTheme">üåô</span>
        </button>
      </div>

      <form id="frm" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Usu√°rio</label>
          <input id="usuario" required
                 class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 outline-none focus:ring-2 ring-blue-500"
                 placeholder="admin" value="admin">
        </div>
        <div>
          <label class="block text-sm mb-1">Senha</label>
          <input id="senha" type="password" required
                 class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 outline-none focus:ring-2 ring-blue-500"
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="123456">
        </div>

        <button id="btnLogin" type="submit"
          class="w-full rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 transition">
          Entrar
        </button>

        <div class="pt-2">
          <details class="text-sm">
            <summary class="cursor-pointer select-none">Testar conex√£o</summary>
            <div class="mt-2 flex items-center gap-2">
              <button type="button" id="btnPing"
                class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 hover:bg-slate-100 dark:hover:bg-slate-800">
                /ping
              </button>
              <pre id="pingOut" class="text-xs opacity-80"></pre>
            </div>
          </details>
        </div>

        <div id="msg" class="hidden mt-2 rounded-xl px-3 py-2 text-sm"></div>
      </form>

      <p class="mt-6 text-center text-xs opacity-60">
        v1 ‚Ä¢ Publicado no GitHub Pages
      </p>
    </div>
  </div>

  <script>
    // ==================== CONFIG ====================
    const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec";
    // =================================================

    const $ = (sel) => document.querySelector(sel);
    const msg = $("#msg");
    const icoTheme = $("#icoTheme");
    const btnTheme = $("#btnTheme");
    const frm = $("#frm");
    const btnPing = $("#btnPing");
    const pingOut = $("#pingOut");

    // Tema
    function setTheme(t) {
      localStorage.setItem("theme", t);
      document.documentElement.classList.toggle("dark", t === "dark");
      icoTheme.textContent = t === "dark" ? "üåô" : "‚òÄÔ∏è";
    }
    btnTheme.addEventListener("click", () => {
      setTheme(document.documentElement.classList.contains("dark") ? "light" : "dark");
    });

    // Helpers
    function showError(text){
      msg.className = "mt-2 rounded-xl px-3 py-2 text-sm bg-red-600/10 text-red-700 dark:text-red-300 border border-red-600/30";
      msg.textContent = text;
      msg.classList.remove("hidden");
    }
    function showOk(text){
      msg.className = "mt-2 rounded-xl px-3 py-2 text-sm bg-emerald-600/10 text-emerald-700 dark:text-emerald-300 border border-emerald-600/30";
      msg.textContent = text;
      msg.classList.remove("hidden");
    }
    function hideMsg(){ msg.classList.add("hidden"); }

    // Teste /ping
    btnPing.addEventListener("click", async () => {
      hideMsg(); pingOut.textContent = "‚Ä¶";
      try{
        const r = await fetch(API_BASE+"?path=/ping", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: "{}",
          // IMPORTANT√çSSIMO: evita preflight CORS
          mode: "cors",
        });
        const j = await r.json();
        pingOut.textContent = JSON.stringify(j, null, 2);
        if(j && j.pong) showOk("API OK");
        else showError("API respondeu, mas sem pong.");
      }catch(e){
        showError("Falha no ping: "+e);
        pingOut.textContent = "";
      }
    });

    // Login
    frm.addEventListener("submit", async (ev) => {
      ev.preventDefault(); hideMsg();
      const usuario = $("#usuario").value.trim();
      const senha   = $("#senha").value.trim();
      if(!usuario || !senha){
        showError("Preencha usu√°rio e senha.");
        return;
      }
      $("#btnLogin").disabled = true;

      try{
        const r = await fetch(API_BASE+"?path=/login", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({usuario, senha}),
          mode: "cors",
        });
        const j = await r.json();

        if(j.error){ showError(j.error); }
        else if(j.session && j.session.token){
          // Guarda sess√£o e vai pro app
          localStorage.setItem("rom.session", JSON.stringify(j.session));
          location.href = "./app.html?v="+Date.now();
        }else{
          showError("Resposta inesperada do servidor.");
        }
      }catch(e){
        showError("Erro de rede: "+e);
      }finally{
        $("#btnLogin").disabled = false;
      }
    });

    // Mant√©m √≠cone inicial do tema
    icoTheme.textContent = (localStorage.getItem("theme")||"dark")==="dark" ? "üåô" : "‚òÄÔ∏è";
  </script>
</body>
</html>
