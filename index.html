<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Login</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --text:#e5e9f0; --muted:#9aa3b2; --primary:#2563eb; --danger:#ef4444; --ok:#16a34a; --input:#0f172a; --ring:#3b82f6;
    }
    .light{
      --bg:#f6f7fb; --card:#ffffff; --text:#0b1220; --muted:#5c6470; --primary:#2563eb; --danger:#dc2626; --ok:#16a34a; --input:#f1f5f9; --ring:#3b82f6;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:420px;margin:5vh auto;padding:24px}
    .card{background:var(--card);border-radius:18px;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 18px;font-size:26px;display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted);font-size:14px;margin-bottom:18px}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid transparent;background:var(--input);color:var(--text);outline:none}
    input:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .row{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:0;cursor:pointer;color:white;background:var(--primary)}
    .btn.secondary{background:#334155}
    .btn.mini{padding:8px 10px;font-size:12px}
    .topbar{display:flex;justify-content:flex-end;margin-bottom:12px;gap:8px}
    .alert{margin-top:14px;background:rgba(239,68,68,.15);color:#fecaca;padding:10px 12px;border-radius:10px;display:none}
    .ok{margin-top:14px;background:rgba(22,163,74,.15);color:#bbf7d0;padding:10px 12px;border-radius:10px;display:none}
    /* progress */
    #progress{position:fixed;left:0;top:0;height:3px;width:0;background:var(--primary);z-index:9999;transition:width .25s}
    .foot{margin-top:10px;display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <div id="progress"></div>
  <div class="container">
    <div class="topbar">
      <button id="btn-theme" class="btn mini secondary" title="Tema">üåô/‚òÄÔ∏è</button>
      <button id="btn-hard" class="btn mini secondary" title="For√ßar atualiza√ß√£o">‚Üª Atualizar</button>
    </div>
    <div class="card">
      <h1>üöö Romaneio</h1>
      <div class="muted">Acesse com seu usu√°rio e senha.</div>

      <label for="user">Usu√°rio</label>
      <input id="user" autocomplete="username" placeholder="admin">

      <label for="pass">Senha</label>
      <input id="pass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

      <div class="row" style="margin-top:16px">
        <button id="btn-login" class="btn" style="flex:1">Entrar</button>
        <button id="btn-test" class="btn secondary">Testar conex√£o</button>
      </div>

      <div id="msg-err" class="alert"></div>
      <div id="msg-ok"  class="ok"></div>

      <div class="foot">
        <small class="muted">v<span id="v"></span></small>
      </div>
    </div>
  </div>

<script>
/* ======= CONFIG ======= */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrDoEP82oJDj2wTIX491414Qf5e-YaDZJHYMAgmWfiddVKCw7WP4oQwrVtEouYxL-NvQ/exec"; // <- sua URL /exec
const VERSION  = "1.0.3";

/* ======= THEME ======= */
function applyTheme(){
  const t = localStorage.getItem("theme") || "dark";
  if(t==="light") document.documentElement.classList.add("light");
  else document.documentElement.classList.remove("light");
}
applyTheme();
document.getElementById("btn-theme").onclick = ()=>{
  const cur = localStorage.getItem("theme") || "dark";
  const nx = cur==="dark"?"light":"dark";
  localStorage.setItem("theme", nx);
  applyTheme();
};

/* ======= HARD REFRESH ======= */
document.getElementById("btn-hard").onclick = ()=>{
  const q = new URLSearchParams(location.search);
  q.set("v", Date.now());
  location.href = location.pathname + "?" + q.toString();
};

/* ======= PROGRESS ======= */
const progress = {
  el: document.getElementById("progress"),
  start(){ this.el.style.width="10%"; requestAnimationFrame(()=> this.el.style.width="70%"); },
  end(){ this.el.style.width="100%"; setTimeout(()=> this.el.style.width="0", 250); }
};

/* ======= UI helpers ======= */
const $ = sel => document.querySelector(sel);
const msgErr = $("#msg-err"), msgOk = $("#msg-ok");
function setErr(t){ msgOk.style.display="none"; if(!t){msgErr.style.display="none";return} msgErr.textContent=t; msgErr.style.display="block"; }
function setOk(t){ msgErr.style.display="none"; if(!t){msgOk.style.display="none";return} msgOk.textContent=t; msgOk.style.display="block"; }

$("#v").textContent = VERSION;

/* ======= API helpers ======= */
async function post(path, body){
  progress.start();
  try{
    const r = await fetch(API_BASE+"?path="+encodeURIComponent(path), {
      method:"POST",
      headers:{"Content-Type":"application/json;charset=utf-8"},
      body: JSON.stringify(body||{})
    });
    const j = await r.json();
    return j;
  }finally{
    progress.end();
  }
}

/* ======= actions ======= */
$("#btn-test").onclick = async ()=>{
  setErr(""); setOk("");
  const j = await post("/ping", {});
  if(j && j.pong) setOk("Conectado: "+j.at); else setErr("Falha no ping");
};

$("#btn-login").onclick = async ()=>{
  setErr(""); setOk("");
  const usuario = $("#user").value.trim();
  const senha   = $("#pass").value.trim();
  if(!usuario || !senha){ setErr("Informe usu√°rio e senha"); return; }
  const j = await post("/login", {usuario, senha});
  if(j && j.session && j.session.token){
    localStorage.setItem("session", JSON.stringify(j.session));
    // vai para o app com cache-buster
    location.href = "app.html?v="+Date.now()+"#rom";
  }else{
    setErr(j && j.error ? j.error : "Falha ao entrar");
  }
};

/* enter key */
["user","pass"].forEach(id=> $( "#"+id ).addEventListener("keydown",e=>{ if(e.key==="Enter") $("#btn-login").click(); }));
</script>
</body>
</html>
